<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i Chi·∫øn H·∫£i S·∫£n - Si√™u M∆∞·ª£t</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        /* T·ªëi ∆∞u hi·ªáu nƒÉng render cho tr√¨nh duy·ªát */
        * { box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            touch-action: none;
            -webkit-user-select: none; user-select: none;
            font-family: 'Roboto', sans-serif;
            background: #222;
        }

        .arena { display: flex; height: 100%; width: 100%; position: relative; }

        .side {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative; z-index: 1;
            /* D√πng opacity ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng nh√°y thay v√¨ ƒë·ªïi m√†u n·ªÅn tr·ª±c ti·∫øp s·∫Ω nh·∫π h∆°n */
            transition: opacity 0.1s;
        }

        .side-left { background: #d32f2f; border-right: 2px solid rgba(0,0,0,0.2); }
        .side-right { background: #1976d2; border-left: 2px solid rgba(0,0,0,0.2); }
        
        /* L·ªõp ph·ªß hi·ªáu ·ª©ng khi b·∫•m */
        .flash-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: white; opacity: 0; pointer-events: none;
        }
        /* Flash b·∫±ng animation (kh√¥ng d√πng setTimeout) -> ƒë·ª° gi·∫≠t khi 2 ng∆∞·ªùi spam tap */
        .flash-overlay.flash { animation: flash 80ms ease-out; }
        @keyframes flash {
            0% { opacity: 0; }
            30% { opacity: 0.30; }
            100% { opacity: 0; }
        }

        .player-info {
            color: white; text-align: center; font-size: clamp(1.5rem, 4vw, 3rem);
            text-transform: uppercase; text-shadow: 2px 2px 0 #000; pointer-events: none;
            z-index: 2;
        }

        .tap-hint {
            font-size: clamp(1rem, 3vw, 1.5rem);
            background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 20px;
            margin-top: 10px; border: 2px solid white; display: inline-block;
        }

        .game-center {
            position: absolute; top: 50%; left: 0; width: 100%; height: 0;
            display: flex; align-items: center; z-index: 10;
        }
        
        .rope-line {
            width: 100%; height: 8px; background: white; position: absolute; top: 0;
            box-shadow: 0 5px 5px rgba(0,0,0,0.3);
        }

        .character-marker {
            position: absolute;
            left: 50%; top: 50%; transform: translate(-50%, -50%); /* CƒÉn gi·ªØa chu·∫©n */
            width: clamp(80px, 15vw, 150px); height: clamp(80px, 15vw, 150px);
            background: white; border-radius: 50%;
            border: 6px solid #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: clamp(40px, 8vw, 80px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            z-index: 20;
            /* Hardware Acceleration: Gi√∫p GPU x·ª≠ l√Ω m∆∞·ª£t h∆°n */
            will-change: left; 
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        
        .hidden { display: none !important; }

        .btn-start {
            font-size: 2rem; padding: 15px 40px; background: #4caf50; color: white;
            border: none; border-radius: 50px; font-family: 'Bangers', cursive;
            margin-top: 20px; cursor: pointer;
        }

        #countdown { font-size: 10rem; font-family: 'Bangers', cursive; color: #ffeb3b; }
    </style>
</head>
<body>

    <div class="overlay" id="overlay">
        <h1 style="font-family: 'Bangers'; font-size: clamp(3rem, 6vw, 5rem); margin: 0; color: #ffeb3b; line-height: 1;">ƒê·∫†I CHI·∫æN<br>H·∫¢I S·∫¢N</h1>
        <p style="font-size: 1.2rem; margin: 20px; color: #ccc;">Ch·∫°m li√™n t·ª•c ƒë·ªÉ k√©o d√¢y!</p>
        <button class="btn-start" onclick="startCountdown()">V√ÄO TR·∫¨N (START)</button>
    </div>

    <div class="overlay hidden" id="cntOverlay">
        <div id="countdown">3</div>
    </div>

    <div class="arena">
        <div class="side side-left" id="zoneLeft">
            <div class="flash-overlay" id="flashLeft"></div>
            <div class="player-info">
                TEAM T√îM ü¶û<br>
                <div class="tap-hint">B·∫§M LI√äN T·ª§C</div>
            </div>
        </div>

        <div class="side side-right" id="zoneRight">
            <div class="flash-overlay" id="flashRight"></div>
            <div class="player-info">
                TEAM CUA ü¶Ä<br>
                <div class="tap-hint">B·∫§M LI√äN T·ª§C</div>
            </div>
        </div>

        <div class="game-center">
            <div class="rope-line"></div>
            <div class="character-marker" id="fighter">üî•</div>
        </div>
    </div>

    <div id="audio-pool" style="display:none"></div>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-whistle" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>

    <script>
        // --- C·∫§U H√åNH ---
        const STEP_VAL = 1.5; // Gi·∫£m xu·ªëng m·ªôt ch√∫t ƒë·ªÉ game k√©o d√†i h∆°n v√¨ gi·ªù b·∫•m r·∫•t m∆∞·ª£t
        
        // --- BI·∫æN TR·∫†NG TH√ÅI (State) ---
        let gameActive = false;
        let position = 50; 
        let currentIcon = "üî•";
        
        

        // --- THAM CHI·∫æU DOM (KH√îNG d·ª±a v√†o bi·∫øn global theo id) ---
        const fighter = document.getElementById('fighter');
        const flashLeft = document.getElementById('flashLeft');
        const flashRight = document.getElementById('flashRight');
        const overlay = document.getElementById('overlay');
        const cntOverlay = document.getElementById('cntOverlay');
        const cntText = document.getElementById('countdown');
        const zoneLeft = document.getElementById('zoneLeft');
        const zoneRight = document.getElementById('zoneRight');
        const sfxWin = document.getElementById('sfx-win');
        const sfxWhistle = document.getElementById('sfx-whistle');

// √Çm thanh tap (WebAudio) -> ch·ªãu ƒë∆∞·ª£c spam tap h∆°n HTMLAudio pool
const TAP_SOUND_URL = "https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3";
let audioCtx = null;
let tapBuffer = null;
let tapGain = null;

async function initTapAudio() {
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        tapGain = audioCtx.createGain();
        tapGain.gain.value = 0.3;
        tapGain.connect(audioCtx.destination);

        const res = await fetch(TAP_SOUND_URL);
        const ab = await res.arrayBuffer();
        tapBuffer = await audioCtx.decodeAudioData(ab);
    } catch (err) {
        // N·∫øu thi·∫øt b·ªã ch·∫∑n / l·ªói m·∫°ng -> game v·∫´n ch·∫°y b√¨nh th∆∞·ªùng, ch·ªâ m·∫•t ti·∫øng tap
        tapBuffer = null;
    }
}

function ensureAudioRunning() {
    // G·ªçi trong user-gesture (touch/keydown/click) ƒë·ªÉ browser cho ph√©p audio
    if (!audioCtx) {
        initTapAudio();
        return;
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume().catch(()=>{});
    }
}

function playTap() {
    if (!audioCtx || !tapBuffer) return;
    // N·∫øu context b·ªã suspend th√¨ resume tr∆∞·ªõc (kh√¥ng block main thread)
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});

    const src = audioCtx.createBufferSource();
    src.buffer = tapBuffer;
    src.connect(tapGain);
    src.start(0);
}

        // --- GAME LOOP (V√íNG L·∫∂P RENDER) ---
        // ƒê√¢y l√† b√≠ quy·∫øt m∆∞·ª£t m√†: T√°ch r·ªùi vi·ªác x·ª≠ l√Ω d·ªØ li·ªáu v√† vi·ªác v·∫Ω h√¨nh
        function loop() {
            if (!gameActive) return;

            // 0. √Åp l·ª±c input 1 l·∫ßn/khung h√¨nh (m∆∞·ª£t h∆°n khi 2 ng∆∞·ªùi b·∫•m c√πng l√∫c)
            if (pendingLeftTaps || pendingRightTaps) {
                position += (pendingRightTaps - pendingLeftTaps) * STEP_VAL;
                pendingLeftTaps = 0;
                pendingRightTaps = 0;

                // Clamp ƒë·ªÉ tr√°nh v∆∞·ª£t bi√™n qu√° nhanh khi spam
                if (position < 0) position = 0;
                else if (position > 100) position = 100;
            }

            if (pendingFlashL) { runFlashOnce(flashLeft); pendingFlashL = false; }
            if (pendingFlashR) { runFlashOnce(flashRight); pendingFlashR = false; }

            // Gi·ªõi h·∫°n ti·∫øng tap: t·ªëi ƒëa 1 ti·∫øng / frame (tr√°nh ngh·∫Ωn audio khi 2 ng∆∞·ªùi spam)
            if (pendingTapSound) { playTap(); pendingTapSound = false; }

            // 1. C·∫≠p nh·∫≠t v·ªã tr√≠ nh√¢n v·∫≠t
            fighter.style.left = position + "%";

            // 2. C·∫≠p nh·∫≠t Icon
            let icon = "üî•";
            if (position < 40) icon = "ü¶û";
            else if (position > 60) icon = "ü¶Ä";
            
            if (fighter.innerHTML !== icon) {
                fighter.innerHTML = icon;
            }

            // 3. Ki·ªÉm tra th·∫Øng thua
            if(position <= 5) endGame("TEAM T√îM ü¶û TH·∫ÆNG!");
            else if(position >= 95) endGame("TEAM CUA ü¶Ä TH·∫ÆNG!");
            
            // 4. L·∫∑p l·∫°i ·ªü khung h√¨nh ti·∫øp theo
            requestAnimationFrame(loop);
        }

        // --- INPUT HANDLING (X·ª¨ L√ù CH·∫†M) ---
// T·ªëi ∆∞u: ch·ªâ "ƒë·∫øm tap" trong event handler, c√≤n update position/DOM s·∫Ω l√†m 1 l·∫ßn/khung h√¨nh trong RAF loop.
var pendingLeftTaps = 0;
var pendingRightTaps = 0;
var pendingFlashL = false;
var pendingFlashR = false;
var pendingTapSound = false;

function enqueueTap(direction, count = 1) {
    if(!gameActive) return;

    if(direction === 'left') {
        pendingLeftTaps += count;
        pendingFlashL = true;
    } else {
        pendingRightTaps += count;
        pendingFlashR = true;
    }
    pendingTapSound = true;
}

function runFlashOnce(element) {
    // Restart animation nh·∫π, kh√¥ng setTimeout (tr√°nh b√£o timer khi 2 ng∆∞·ªùi spam)
    element.classList.remove('flash');
    // eslint-disable-next-line no-unused-expressions
    element.offsetWidth; // force reflow ƒë·ªÉ restart animation
    element.classList.add('flash');
}

        // --- C√ÅC H√ÄM ƒêI·ªÄU KHI·ªÇN GAME ---
        function startCountdown() {
            ensureAudioRunning();
            overlay.classList.add('hidden');
            cntOverlay.classList.remove('hidden');
            let count = 3;
            cntText.innerText = count;

            const interval = setInterval(() => {
                count--;
                if(count > 0) {
                    cntText.innerText = count;
                    playTap();
                } else {
                    clearInterval(interval);
                    cntText.innerText = "FIGHT!";
                    sfxWhistle.play();
                    setTimeout(() => {
                        cntOverlay.classList.add('hidden');
                        startGame();
                    }, 500);
                }
            }, 1000);
        }

        function startGame() {
            gameActive = true;
            position = 50;
            requestAnimationFrame(loop); // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p v·∫Ω h√¨nh
        }

        function endGame(msg) {
            gameActive = false;
            sfxWin.play();
            overlay.innerHTML = `
                <h1 style="font-family:'Bangers'; color:#ffeb3b; font-size:3rem;">${msg}</h1>
                <div style="font-size:4rem; margin:10px;">üèÜ</div>
                <button class="btn-start" onclick="location.reload()">ƒê·∫§U L·∫†I</button>
            `;
            overlay.classList.remove('hidden');
        }

        // --- S·ª∞ KI·ªÜN C·∫¢M ·ª®NG (MULTI-TOUCH) ---
        zoneLeft.addEventListener('touchstart', (e) => {
            if(!gameActive) return;
            ensureAudioRunning();
            e.preventDefault();
            enqueueTap('left', e.changedTouches.length || 1);
        }, { passive: false });

        zoneRight.addEventListener('touchstart', (e) => {
            if(!gameActive) return;
            ensureAudioRunning();
            e.preventDefault();
            enqueueTap('right', e.changedTouches.length || 1);
        }, { passive: false });

        // --- S·ª∞ KI·ªÜN B√ÄN PH√çM ---
        document.addEventListener('keydown', (e) => {
            if(!gameActive) return;
            ensureAudioRunning();
            if(e.code === 'KeyS' || e.key === 's' || e.key === 'S') enqueueTap('left', 1);
            if(e.code === 'KeyK' || e.key === 'k' || e.key === 'K') enqueueTap('right', 1);
        });


        // Broadcast Listener (ƒê·ªÉ Game Master ƒëi·ªÅu khi·ªÉn n·∫øu c·∫ßn)
        const bc_listener = new BroadcastChannel('kyha_channel');
        bc_listener.onmessage = (event) => {
            if (event.data === 'reload_all') location.reload();
        };

    </script>
</body>
</html>
