<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trao Qu√† T·∫øt (Clean)</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Be+Vietnam+Pro:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #FFFDE7;
            --text-color: #D32F2F;
            --gold: #FFC107;
            --border-color: #FFCDD2;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; padding: 0; height: 100vh;
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(#FFEB3B 10%, transparent 10%),
                radial-gradient(#FFEB3B 10%, transparent 10%);
            background-position: 0 0, 20px 20px;
            background-size: 40px 40px;
            color: var(--text-color);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .top-bar {
            height: 60px; padding: 0 10px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100; flex-shrink: 0;
        }
        .game-title {
            font-family: 'Anton', sans-serif; font-size: 1.5rem; color: #D32F2F;
            text-transform: uppercase; letter-spacing: 1px;
            border: 2px dashed transparent; padding: 0 5px; cursor: text;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .controls-top { 
            display: flex; gap: 5px; align-items: center; 
            flex-wrap: nowrap; overflow-x: auto; 
            padding-bottom: 5px; -webkit-overflow-scrolling: touch;
        }
        .controls-top::-webkit-scrollbar { display: none; }

        /* BUTTONS */
        .btn {
            padding: 8px 12px; border-radius: 20px; border: none; white-space: nowrap;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;
            font-size: 0.8rem; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; 
        }
        .btn:active { transform: translateY(2px); }
        .btn-settings { background: #607D8B; color: white; }
        .btn-undo { background: #FF9800; color: white; }
        
        .btn-reset { 
            background: #D50000; color: white; 
            border: 2px solid #FF8A80;
            box-shadow: 0 0 5px rgba(213, 0, 0, 0.4);
        }
        
        /* Audio Buttons */
        .btn-default-music { background: #E91E63; color: white; } 
        .btn-sfx { background: #9C27B0; color: white; padding: 8px 15px; font-size: 1rem; } 
        .btn-music-upload { background: #009688; color: white; }

        .btn-full { background: #333; color: white; }
        
        .btn-spin { 
            background: linear-gradient(45deg, #673AB7, #9C27B0); color: white; 
            padding: 8px 20px; font-size: 0.9rem;
            animation: pulseBtn 2s infinite; 
            border: 2px solid #fff;
        }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* MAIN LAYOUT */
        .main-container {
            flex: 1; display: flex; overflow: hidden;
            padding: 10px; gap: 15px;
            height: calc(100vh - 60px);
        }

        .gift-area {
            flex: 1; 
            background: rgba(255,255,255,0.7);
            border-radius: 20px; border: 4px solid var(--border-color);
            padding: 15px;
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }

        .gift-grid {
            display: grid; gap: 15px; width: 100%; height: 100%;
            justify-content: center; align-content: center;
        }

        .gift-box {
            position: relative;
            background-image: url('https://cdn.hstatic.net/files/200000273197/file/copy_921962d0-b487-49ce-9bc5-08522bbfbd46.png');
            background-size: contain; background-repeat: no-repeat;
            background-position: center bottom;
            width: 100%; height: 100%; cursor: pointer;
            transition: all 0.3s ease;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
        }
        .gift-box:hover { transform: scale(1.05) rotate(2deg); z-index: 10; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2)); }
        
        .gift-box.taken {
            background-image: none !important; 
            background-color: rgba(0,0,0,0.05);
            border-radius: 10px; border: 2px dashed #ddd;
            cursor: default !important; transform: scale(0.95) !important;
            pointer-events: none !important; box-shadow: none !important;
            filter: grayscale(100%) opacity(0.5) !important;
        }
        .gift-box.taken::after {
            content: attr(data-owner);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #bbb; font-weight: bold; font-size: clamp(0.8rem, 1.5vw, 1.2rem);
            white-space: nowrap; text-transform: uppercase;
        }

        .gift-box.self-locked {
            opacity: 0.5; filter: grayscale(100%); cursor: not-allowed;
        }
        .gift-box.self-locked::before {
            content: "‚õîÔ∏è"; font-size: clamp(2rem, 5vw, 4rem);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 5;
        }

        .player-area {
            width: 280px; background: #fff; border-radius: 20px;
            display: flex; flex-direction: column;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .player-header {
            padding: 15px; text-align: center;
            font-weight: 900; text-transform: uppercase; color: #D32F2F;
            border-bottom: 2px dashed var(--border-color);
            background: #FFF8E1; border-radius: 18px 18px 0 0;
        }
        .player-list {
            flex: 1; overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .player-btn {
            background: #FAFAFA; color: #555; padding: 10px 12px;
            border: 1px solid #eee; border-radius: 10px; cursor: pointer;
            text-align: left; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600;
        }
        .player-btn:hover { background: #FFEB3B; color: #D32F2F; border-color: #FFC107; }
        
        .player-btn.active {
            background: #D32F2F; color: #fff; border-color: #B71C1C;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); transform: scale(1.02);
        }
        .player-btn.done {
            background: #EEEEEE !important; color: #BDBDBD !important;
            border-color: transparent !important; text-decoration: line-through;
            opacity: 0.6; pointer-events: none;
        }

        /* MODAL */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #fff; color: #333; padding: 25px; border-radius: 20px;
            width: 90%; max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 2px solid #D32F2F;
            position: relative;
        }
        textarea { width: 100%; height: 150px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-family: inherit; }
        
        /* SPIN WHEEL MODAL */
        #spinModal .modal-content {
            background: transparent; border: none; box-shadow: none;
            display: flex; flex-direction: column; align-items: center;
        }
        .wheel-container {
            position: relative; width: 400px; height: 400px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            display: flex; justify-content: center; align-items: center;
        }
        canvas#wheelCanvas { width: 100%; height: 100%; transform: rotate(0deg); transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }
        .wheel-pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 50px; background: #D32F2F;
            clip-path: polygon(100% 0, 50% 100%, 0 0); z-index: 10;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
        
        /* WINNER DISPLAY */
        .spin-winner-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7); border-radius: 50%;
            animation: zoomIn 0.3s; z-index: 20;
        }
        .spin-winner-text {
            font-family: 'Anton'; font-size: 3rem; color: #FFFF00; 
            text-shadow: 3px 3px 0 #D32F2F; text-align: center; line-height: 1.1;
            margin-bottom: 20px; max-width: 90%;
        }
        .spin-winner-btn {
            padding: 10px 30px; font-size: 1.1rem; background: #4CAF50; color: white;
            border: 2px solid white; border-radius: 30px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #spinBtnStart {
            margin-top: 20px; padding: 15px 50px; font-size: 1.5rem;
            background: var(--gold); color: #D32F2F; border: 4px solid white;
            border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* POPUP RESULT */
        .result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.3s;
        }
        .result-overlay.show { display: flex; }
        .result-box {
            background: url('https://cdn.hstatic.net/files/200000273197/file/tui-vang.png') no-repeat center top;
            background-size: 180px; padding-top: 190px; padding-bottom: 30px;
            padding-left: 40px; padding-right: 40px;
            background-color: #fff; border-radius: 30px;
            text-align: center; box-shadow: 0 0 60px rgba(255, 193, 7, 0.6);
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%; min-width: 300px;
        }
        .result-title { font-size: 1.1rem; color: #757575; text-transform: uppercase; margin-bottom: 5px; }
        .result-name { 
            font-family: 'Anton', sans-serif; font-size: clamp(2rem, 6vw, 3.5rem); 
            color: #D32F2F; line-height: 1.1; text-transform: uppercase; margin-bottom: 10px;
        }
        .result-note { color: #aaa; font-size: 0.8rem; font-style: italic;}

        /* MODALS (Finale, GameOver) */
        #gameOverModal .modal-content, #finaleModal .modal-content, #lastPairModal .modal-content {
            text-align: center; background: linear-gradient(135deg, #fff, #FFF8E1);
        }
        .end-title { font-family: 'Anton'; font-size: 2.5rem; color: #D32F2F; margin-bottom: 10px; }
        .end-desc { font-size: 1.2rem; color: #555; margin-bottom: 20px; }
        .finale-list { 
            background: #FFF3E0; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            font-weight: bold; color: #E65100; display: grid; gap: 5px;
        }
        .btn-big-reset {
            font-size: 1.5rem; padding: 15px 40px; background: #FF5722; color: white;
            border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 15px rgba(255,87,34,0.4);
            animation: pulseBtn 2s infinite;
        }

        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes zoomIn { from{transform:scale(0)} to{transform:scale(1)} }

        #music-input { display: none; }

    </style>
</head>
<body>

    <div class="top-bar">
        <button class="btn btn-reset" onclick="confirmReset()">üîÑ CH∆†I L·∫†I</button>
        <div class="game-title" contenteditable="true" spellcheck="false">üéÅ TRAO QU√Ä</div>
        <div class="controls-top">
            
            <button class="btn btn-spin" id="btnSpinMenu" onclick="openSpinModal()">üé° Quay</button>

            <button class="btn btn-default-music" onclick="toggleDefaultMusic()" id="btnDefMusic">üîà Nh·∫°c N·ªÅn</button>
            <button class="btn btn-sfx" onclick="toggleSFX()" id="btnSfx">üîä</button>

            <button class="btn btn-music-upload" onclick="document.getElementById('music-input').click()">üìÇ</button>
            <button class="btn btn-music-upload" onclick="toggleMusic()" id="btnPlayMusic">‚ñ∂Ô∏è</button>

            <button class="btn btn-undo" onclick="undo()" id="btnUndo" disabled>‚Ü©Ô∏è</button>
            <button class="btn btn-settings" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="btn btn-full" onclick="toggleFullScreen()">‚õ∂</button>
        </div>
    </div>

    <div class="main-container">
        <div class="gift-area" id="giftContainer">
            <div class="gift-grid" id="giftGrid"></div>
        </div>
        <div class="player-area">
            <div class="player-header">DANH S√ÅCH H·ªò GIA ƒê√åNH</div>
            <div class="player-list" id="playerList"></div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2 style="margin-top:0; color:#D32F2F; text-align:center;">DANH S√ÅCH THAM GIA</h2>
            <p style="text-align:center; color:#666; font-size:0.9rem;">Nh·∫≠p t√™n m·ªói h·ªô tr√™n 1 d√≤ng</p>
            <textarea id="listInput" placeholder="H·ªô A
H·ªô B
H·ªô C..."></textarea>
            
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
                <button class="btn btn-settings" style="background:#ddd; color:#333" onclick="closeSettings()">ƒê√≥ng</button>
                <button class="btn btn-music" style="background:#D32F2F; padding: 10px 30px;" onclick="saveSettings()">L∆∞u & Ch∆°i M·ªõi</button>
            </div>
        </div>
    </div>

    <div class="modal" id="spinModal">
        <div class="modal-content">
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <canvas id="wheelCanvas" width="400" height="400"></canvas>
                
                <div id="spinWinnerDisplay" class="spin-winner-overlay">
                    <div class="spin-winner-text" id="winnerText">T√äN</div>
                    <button class="spin-winner-btn" onclick="confirmSpinWinner()">OK, L√äN S√ÇN KH·∫§U! üëá</button>
                </div>
            </div>
            
            <button class="btn" id="spinBtnStart" onclick="startSpin()">QUAY NGAY</button>
            <button class="btn btn-settings" id="spinBtnClose" style="margin-top:10px; background:rgba(0,0,0,0.5);" onclick="closeSpinModal()">ƒê√≥ng</button>
        </div>
    </div>

    <div class="modal" id="finaleModal">
        <div class="modal-content">
            <div class="end-title">üëë V√íNG ƒê·∫∂C BI·ªÜT üëë</div>
            <div class="end-desc">Ch·ªâ c√≤n 4 h·ªô cu·ªëi c√πng! M·ªùi t·∫•t c·∫£ c√πng l√™n s√¢n kh·∫•u!</div>
            <div class="finale-list" id="finaleList"></div>
            <div class="end-desc" style="font-size:0.9rem; font-style:italic">H√£y quay ƒë·ªÉ ch·ªçn ra ng∆∞·ªùi m·ªü h·ªôp qu√† ƒë·∫ßu ti√™n!</div>
            <button class="btn-settings" style="background:#4CAF50; color:white; padding: 10px 30px;" onclick="document.getElementById('finaleModal').classList.remove('show'); openSpinModal();">OK, QUAY NGAY</button>
        </div>
    </div>

    <div class="modal" id="lastPairModal">
        <div class="modal-content">
            <div class="end-title">‚ù§Ô∏è C·∫∂P ƒê√îI CU·ªêI C√ôNG ‚ù§Ô∏è</div>
            <div class="end-desc">V√¨ ch·ªâ c√≤n l·∫°i 2 h·ªô n√™n s·∫Ω t·ª± ƒë·ªông gh√©p c·∫∑p:</div>
            <div class="finale-list" id="lastPairList"></div>
            <button class="btn-settings" style="background:#E91E63; color:white; padding: 10px 30px;" onclick="document.getElementById('lastPairModal').classList.remove('show'); finishGame();">TRAO QU√Ä & K·∫æT TH√öC</button>
        </div>
    </div>

    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <div class="end-title">üéâ ƒê√É H·∫æT QU√Ä! üéâ</div>
            <div class="end-desc">Ch∆∞∆°ng tr√¨nh trao ƒë·ªïi qu√† ƒë√£ ho√†n t·∫•t.</div>
            <button class="btn-big-reset" onclick="confirmReset()">üîÑ CH∆†I V√ÅN M·ªöI</button>
            <button class="btn btn-settings" style="margin-top:20px; background:rgba(0,0,0,0.1); color:#888;" onclick="document.getElementById('gameOverModal').classList.remove('show')">ƒê√≥ng</button>
        </div>
    </div>

    <div class="result-overlay" id="resultOverlay" onclick="closeResult()">
        <div class="result-box">
            <div class="result-title">M√≥n qu√† ƒë·∫øn t·ª´</div>
            <div class="result-name" id="resultName">H·ªò GIA ƒê√åNH A</div>
            <div class="result-note">(Ch·∫°m m√†n h√¨nh ƒë·ªÉ ƒë√≥ng)</div>
        </div>
        <canvas id="fireworks" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
    </div>

    <input type="file" id="music-input" accept="audio/*, .mp3" onchange="handleFileSelect(this)">
    <audio id="bgAudio" loop></audio>
    <audio id="defaultTheme" loop src="xoso.mp3"></audio> 
    <audio id="sfxOpen" src="https://www.myinstants.com/media/sounds/tada_1.mp3"></audio>

    <script>
        // GAME LOGIC START (No hidden variables)
        let players = []; 
        let gifts = [];   
        let currentPlayerIndex = -1;
        let historyStack = [];
        let sfxEnabled = true;

        const giftGrid = document.getElementById('giftGrid');
        const playerList = document.getElementById('playerList');
        const resultOverlay = document.getElementById('resultOverlay');
        const resultName = document.getElementById('resultName');
        const bgAudio = document.getElementById('bgAudio');
        const defaultTheme = document.getElementById('defaultTheme');
        const sfxOpen = document.getElementById('sfxOpen');

        let spinCandidates = [];
        let isSpinning = false;
        let currentWinnerObj = null;

        function initGame() {
            const savedList = localStorage.getItem('traoqua_clean_v24');
            if (savedList) {
                players = JSON.parse(savedList);
            } else {
                players = Array.from({length: 12}, (_, i) => `H·ªô Gia ƒê√¨nh ${i+1}`);
            }

            gifts = players.map((name, index) => ({
                ownerIndex: index,
                ownerName: name,
                status: 'available', 
                displayOrder: Math.random() 
            }));

            currentPlayerIndex = -1;
            historyStack = [];
            
            document.getElementById('gameOverModal').classList.remove('show');
            document.getElementById('finaleModal').classList.remove('show');
            document.getElementById('lastPairModal').classList.remove('show');
            document.getElementById('btnSpinMenu').disabled = false;
            document.getElementById('btnSpinMenu').style.opacity = '1';
            
            updateUI();
        }

        function confirmReset() {
            if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën CH∆†I L·∫†I T·ª™ ƒê·∫¶U kh√¥ng?\nTo√†n b·ªô l·ªãch s·ª≠ ch∆°i hi·ªán t·∫°i s·∫Ω b·ªã x√≥a.")) {
                initGame(); 
                document.getElementById('gameOverModal').classList.remove('show');
            }
        }

        function updateUI() {
            renderGrid();
            renderPlayerList();
            document.getElementById('btnUndo').disabled = historyStack.length === 0;
        }

        function renderGrid() {
            giftGrid.innerHTML = '';
            const total = gifts.length;
            const container = document.getElementById('giftContainer');
            const cw = container.clientWidth;
            const ch = container.clientHeight;
            let bestCols = Math.ceil(Math.sqrt(total));
            let maxBoxSize = 0;

            for(let c = 1; c <= total; c++) {
                const r = Math.ceil(total / c);
                const w = (cw - (c-1)*15) / c;
                const h = (ch - (r-1)*15) / r;
                const size = Math.min(w, h);
                if(size > maxBoxSize) { maxBoxSize = size; bestCols = c; }
            }
            
            giftGrid.style.gridTemplateColumns = `repeat(${bestCols}, ${maxBoxSize}px)`;
            giftGrid.style.gridTemplateRows = `repeat(${Math.ceil(total/bestCols)}, ${maxBoxSize}px)`;

            const sortedGifts = [...gifts].sort((a, b) => a.displayOrder - b.displayOrder);

            sortedGifts.forEach(gift => {
                const box = document.createElement('div');
                box.className = 'gift-box';
                box.setAttribute('data-owner', gift.ownerName);

                if (gift.status === 'taken') {
                    box.classList.add('taken');
                }

                if (currentPlayerIndex !== -1 && gift.ownerIndex === currentPlayerIndex) {
                    box.classList.add('self-locked');
                    box.title = "Qu√† nh√† m√¨nh!";
                }

                box.onclick = () => handleGiftClick(gift);
                giftGrid.appendChild(box);
            });
        }

        function renderPlayerList() {
            playerList.innerHTML = '';
            players.forEach((name, index) => {
                const btn = document.createElement('div');
                btn.className = 'player-btn';
                
                const isParticipated = historyStack.some(h => 
                    h.pickerIndex === index || h.giftOwnerIndex === index
                );

                if (isParticipated) {
                    btn.classList.add('done'); 
                }

                if (index === currentPlayerIndex) {
                    btn.classList.remove('done'); 
                    btn.classList.add('active');
                }

                let statusIcon = isParticipated ? 'üéÅ‚úÖ' : '';
                btn.innerHTML = `<span>${index + 1}. ${name}</span> <small>${statusIcon}</small>`;
                btn.onclick = () => { if (!isParticipated) setPlayer(index); };
                playerList.appendChild(btn);
            });
        }

        function setPlayer(index) {
            currentPlayerIndex = index;
            updateUI(); 
        }

        function handleGiftClick(clickedGift) {
            if (currentPlayerIndex === -1) {
                alert("Vui l√≤ng ch·ªçn H·ªô Gia ƒê√¨nh l√™n ch∆°i tr∆∞·ªõc!");
                return;
            }
            if (clickedGift.status === 'taken') return; 
            if (clickedGift.ownerIndex === currentPlayerIndex) {
                alert("ƒê√¢y l√† qu√† nh√† m√¨nh m√†! Ch·ªçn h·ªôp kh√°c nh√©!");
                return;
            }

            let finalGift = clickedGift;

            // Pure Logic: What you click is what you get
            historyStack.push({
                pickerIndex: currentPlayerIndex,
                giftOwnerIndex: finalGift.ownerIndex
            });

            finalGift.status = 'taken';
            const pickerGift = gifts.find(g => g.ownerIndex === currentPlayerIndex);
            if (pickerGift) pickerGift.status = 'taken';
            
            showResult(finalGift.ownerName);
            currentPlayerIndex = -1;
            updateUI();
        }

        function undo() {
            if (historyStack.length === 0) return;
            const lastAction = historyStack.pop();
            const targetGift = gifts.find(g => g.ownerIndex === lastAction.giftOwnerIndex);
            if (targetGift) targetGift.status = 'available';
            const pickerGift = gifts.find(g => g.ownerIndex === lastAction.pickerIndex);
            if (pickerGift) pickerGift.status = 'available';
            currentPlayerIndex = lastAction.pickerIndex;
            updateUI();
        }

        function openSpinModal() {
            document.getElementById('spinWinnerDisplay').style.display = 'none';
            document.getElementById('spinBtnStart').style.display = 'block';
            document.getElementById('spinBtnClose').style.display = 'block';
            document.getElementById('wheelCanvas').style.opacity = '1';

            spinCandidates = players.map((name, index) => ({name, index}))
                                    .filter(p => {
                                        const isParticipated = historyStack.some(h => 
                                            h.pickerIndex === p.index || h.giftOwnerIndex === p.index
                                        );
                                        return !isParticipated;
                                    });

            if (spinCandidates.length === 0) {
                alert("T·∫•t c·∫£ m·ªçi ng∆∞·ªùi ƒë√£ tham gia r·ªìi!");
                return;
            }
            drawWheel();
            document.getElementById('spinModal').classList.add('show');
        }

        function closeSpinModal() {
            document.getElementById('spinModal').classList.remove('show');
            stopFireworks();
        }

        function drawWheel() {
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');
            const numSegments = spinCandidates.length;
            const arcSize = (2 * Math.PI) / numSegments;
            const colors = ['#FFEB3B', '#FF9800', '#F44336', '#4CAF50', '#2196F3', '#9C27B0'];

            ctx.clearRect(0, 0, 400, 400);
            
            for (let i = 0; i < numSegments; i++) {
                const angle = i * arcSize - Math.PI / 2;
                ctx.beginPath();
                ctx.moveTo(200, 200);
                ctx.arc(200, 200, 190, angle, angle + arcSize);
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.stroke();
                ctx.save();
                ctx.translate(200 + Math.cos(angle + arcSize / 2) * 140, 
                              200 + Math.sin(angle + arcSize / 2) * 140);
                ctx.rotate(angle + arcSize / 2 + Math.PI / 2);
                ctx.fillStyle = "#000";
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(spinCandidates[i].name, 0, 0);
                ctx.restore();
            }
        }

        function startSpin() {
            if (isSpinning || spinCandidates.length === 0) return;
            isSpinning = true;
            document.getElementById('spinBtnStart').disabled = true;

            const minSpins = 5;
            
            // Randomly select winner from full list
            currentWinnerObj = spinCandidates[Math.floor(Math.random() * spinCandidates.length)];
            const randIndex = spinCandidates.findIndex(p => p.index === currentWinnerObj.index);

            const segmentAngle = 360 / spinCandidates.length;
            const stopAngle = minSpins * 360 + (360 - (randIndex * segmentAngle) - segmentAngle/2);
            
            const canvas = document.getElementById('wheelCanvas');
            canvas.style.transition = "transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)";
            canvas.style.transform = `rotate(${stopAngle}deg)`;

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('spinBtnStart').disabled = false;
                canvas.style.transition = "none";
                canvas.style.transform = `rotate(${stopAngle % 360}deg)`;
                
                showSpinWinnerOverlay(currentWinnerObj.name);
            }, 4000);
        }

        function showSpinWinnerOverlay(name) {
            document.getElementById('spinBtnStart').style.display = 'none';
            document.getElementById('spinBtnClose').style.display = 'none';
            document.getElementById('wheelCanvas').style.opacity = '0.3';
            
            const winDisplay = document.getElementById('spinWinnerDisplay');
            document.getElementById('winnerText').innerText = name;
            winDisplay.style.display = 'flex';
            
            if(sfxEnabled) { sfxOpen.currentTime = 0; sfxOpen.play(); }
            startFireworks();
        }

        function confirmSpinWinner() {
            setPlayer(currentWinnerObj.index);
            closeSpinModal();
        }

        function showResult(name) {
            resultName.innerText = name;
            resultOverlay.classList.add('show');
            if(sfxEnabled) { sfxOpen.currentTime = 0; sfxOpen.play(); }
            startFireworks();
        }

        function closeResult() {
            resultOverlay.classList.remove('show');
            stopFireworks();
            
            const takenCount = gifts.filter(g => g.status === 'taken').length;
            const remainingCount = players.length - takenCount;

            if(takenCount >= gifts.length) {
                setTimeout(() => {
                    document.getElementById('gameOverModal').classList.add('show');
                }, 800);
            }
            else if (remainingCount === 4) {
                const leftNames = gifts.filter(g => g.status === 'available').map(g => g.ownerName);
                document.getElementById('finaleList').innerHTML = leftNames.map(n => `<div>‚≠êÔ∏è ${n}</div>`).join('');
                setTimeout(() => {
                    document.getElementById('finaleModal').classList.add('show');
                    document.getElementById('btnSpinMenu').disabled = true;
                    document.getElementById('btnSpinMenu').style.opacity = '0.5';
                }, 800);
            }
            else if (remainingCount === 2) {
                const leftNames = gifts.filter(g => g.status === 'available').map(g => g.ownerName);
                document.getElementById('lastPairList').innerHTML = 
                    `<div style="font-size:1.5rem; color:#E91E63">${leftNames[0]} ‚ù§Ô∏è ${leftNames[1]}</div>`;
                setTimeout(() => {
                    document.getElementById('lastPairModal').classList.add('show');
                }, 800);
            }
        }

        function finishGame() {
            gifts.forEach(g => {
                if(g.status === 'available') g.status = 'taken';
            });
            updateUI();
            setTimeout(() => {
                document.getElementById('gameOverModal').classList.add('show');
            }, 500);
        }

        function openSettings() {
            document.getElementById('listInput').value = players.join('\n');
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings() {
            const text = document.getElementById('listInput').value.trim();
            if (text) {
                const list = text.split('\n').map(s => s.trim()).filter(s => s !== "");
                if (list.length > 0) {
                    localStorage.setItem('traoqua_clean_v24', JSON.stringify(list));
                    initGame();
                    closeSettings();
                } else { alert("Danh s√°ch tr·ªëng!"); }
            }
        }

        // --- AUDIO ---
        function toggleDefaultMusic() {
            const btn = document.getElementById('btnDefMusic');
            if (defaultTheme.paused) {
                defaultTheme.play();
                btn.innerText = "üîà ƒêang Ph√°t";
                btn.style.opacity = "1";
            } else {
                defaultTheme.pause();
                btn.innerText = "üîà Nh·∫°c N·ªÅn";
                btn.style.opacity = "0.7";
            }
        }

        function toggleSFX() {
            sfxEnabled = !sfxEnabled;
            const btn = document.getElementById('btnSfx');
            if (sfxEnabled) {
                btn.innerText = "üîä";
                btn.style.opacity = "1";
            } else {
                btn.innerText = "üîá";
                btn.style.opacity = "0.7";
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                bgAudio.src = URL.createObjectURL(file);
                bgAudio.play();
                document.getElementById('btnPlayMusic').innerText = "‚è∏";
                defaultTheme.pause();
                document.getElementById('btnDefMusic').innerText = "üîà Nh·∫°c N·ªÅn";
            }
        }

        function toggleMusic() {
            if (bgAudio.paused && bgAudio.src) {
                bgAudio.play();
                document.getElementById('btnPlayMusic').innerText = "‚è∏";
                defaultTheme.pause();
            } else {
                bgAudio.pause();
                document.getElementById('btnPlayMusic').innerText = "‚ñ∂Ô∏è";
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        window.addEventListener('resize', () => { renderGrid(); });

        let fwInterval;
        const canvas = document.getElementById('fireworks');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function startFireworks() {
            const particles = [];
            function createParticle(x, y) {
                const count = 40;
                for (let i = 0; i < count; i++) {
                    particles.push({
                        x: x, y: y,
                        vx: (Math.random() - 0.5) * 15,
                        vy: (Math.random() - 0.5) * 15,
                        life: 1,
                        color: `hsl(${Math.random()*360}, 100%, 60%)`
                    });
                }
            }
            fwInterval = setInterval(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if(Math.random() < 0.1) createParticle(Math.random()*canvas.width, Math.random()*canvas.height/2);
                for (let i = 0; i < particles.length; i++) {
                    let p = particles[i];
                    p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
                    ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                    if (p.life <= 0) particles.splice(i, 1);
                }
            }, 20);
            createParticle(canvas.width/2, canvas.height/2);
        }

        function stopFireworks() {
            clearInterval(fwInterval);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        initGame();

    </script>
</body>
</html>
