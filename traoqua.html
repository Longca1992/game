<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trao Qu√† T·∫øt V6 (Swap Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Be+Vietnam+Pro:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #FFFDE7;
            --text-color: #D32F2F;
            --gold: #FFC107;
            --border-color: #FFCDD2;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; padding: 0; height: 100vh;
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(#FFEB3B 10%, transparent 10%),
                radial-gradient(#FFEB3B 10%, transparent 10%);
            background-position: 0 0, 20px 20px;
            background-size: 40px 40px;
            color: var(--text-color);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .top-bar {
            height: 60px; padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100; flex-shrink: 0;
        }
        .game-title {
            font-family: 'Anton', sans-serif; font-size: 1.8rem; color: #D32F2F;
            text-transform: uppercase; letter-spacing: 1px;
            border: 2px dashed transparent; padding: 0 10px; cursor: text;
        }
        .controls-top { display: flex; gap: 8px; align-items: center; }

        /* MAIN LAYOUT */
        .main-container {
            flex: 1; display: flex; overflow: hidden;
            padding: 10px; gap: 15px;
            height: calc(100vh - 60px);
        }

        /* GIFT AREA */
        .gift-area {
            flex: 1; 
            background: rgba(255,255,255,0.7);
            border-radius: 20px; border: 4px solid var(--border-color);
            padding: 15px;
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }

        .gift-grid {
            display: grid; gap: 15px; width: 100%; height: 100%;
            justify-content: center; align-content: center;
        }

        .gift-box {
            position: relative;
            background-image: url('https://cdn.hstatic.net/files/200000273197/file/copy_921962d0-b487-49ce-9bc5-08522bbfbd46.png');
            background-size: contain; background-repeat: no-repeat;
            background-position: center bottom;
            width: 100%; height: 100%; cursor: pointer;
            transition: all 0.3s ease;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
        }
        .gift-box:hover { transform: scale(1.05) rotate(2deg); z-index: 10; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2)); }
        
        /* --- TR·∫†NG TH√ÅI: ƒê√É M·ªû / ƒê√É XONG (CH√åM H·∫≤N) --- */
        .gift-box.taken {
            background-image: none !important; 
            background-color: rgba(0,0,0,0.05); /* R·∫•t m·ªù */
            border-radius: 10px;
            border: 2px dashed #ddd;
            cursor: default !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            box-shadow: none !important;
            filter: grayscale(100%) opacity(0.5) !important;
        }
        /* Hi·ªÉn th·ªã t√™n ch·ªß nh√¢n m·ªù m·ªù ƒë·ªÉ bi·∫øt h·ªôp n√†y c·ªßa ai */
        .gift-box.taken::after {
            content: attr(data-owner); /* Hi·ªán t√™n ch·ªß h·ªôp */
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #bbb; font-weight: bold; font-size: clamp(0.8rem, 1.5vw, 1.2rem);
            white-space: nowrap; text-transform: uppercase;
        }

        /* --- TR·∫†NG TH√ÅI: ƒêANG CH∆†I (T·∫†M KH√ìA) --- */
        .gift-box.self-locked {
            opacity: 0.5; filter: grayscale(100%); cursor: not-allowed;
        }
        .gift-box.self-locked::before {
            content: "‚õîÔ∏è"; font-size: clamp(2rem, 5vw, 4rem);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 5;
        }

        /* PLAYER LIST */
        .player-area {
            width: 280px; background: #fff; border-radius: 20px;
            display: flex; flex-direction: column;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .player-header {
            padding: 15px; text-align: center;
            font-weight: 900; text-transform: uppercase; color: #D32F2F;
            border-bottom: 2px dashed var(--border-color);
            background: #FFF8E1; border-radius: 18px 18px 0 0;
        }
        .player-list {
            flex: 1; overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .player-btn {
            background: #FAFAFA; color: #555; padding: 10px 12px;
            border: 1px solid #eee; border-radius: 10px; cursor: pointer;
            text-align: left; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600;
        }
        .player-btn:hover { background: #FFEB3B; color: #D32F2F; border-color: #FFC107; }
        
        /* ƒêang ch·ªçn (Active) */
        .player-btn.active {
            background: #D32F2F; color: #fff;
            border-color: #B71C1C;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
            transform: scale(1.02);
        }
        
        /* CH√åM M√ÄU (ƒê√£ tham gia) */
        .player-btn.done {
            background: #EEEEEE !important; 
            color: #BDBDBD !important;
            border-color: transparent !important;
            text-decoration: line-through;
            opacity: 0.6;
            pointer-events: none; /* Kh√¥ng cho b·∫•m n·ªØa */
        }

        /* BUTTONS */
        .btn {
            padding: 8px 12px; border-radius: 12px; border: none;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;
            font-size: 0.85rem; transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:active { transform: translateY(2px); }
        .btn-settings { background: #607D8B; color: white; }
        .btn-undo { background: #FF9800; color: white; }
        .btn-music { background: #009688; color: white; }
        .btn-full { background: #9C27B0; color: white; }

        /* MODAL */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #fff; color: #333; padding: 25px; border-radius: 20px;
            width: 90%; max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 2px solid #D32F2F;
        }
        textarea { width: 100%; height: 150px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-family: inherit; }
        
        /* POPUP RESULT */
        .result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 500;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.3s;
        }
        .result-overlay.show { display: flex; }
        
        .result-box {
            background: url('https://cdn.hstatic.net/files/200000273197/file/tui-vang.png') no-repeat center top;
            background-size: 180px;
            padding-top: 190px; padding-bottom: 30px;
            padding-left: 40px; padding-right: 40px;
            background-color: #fff; border-radius: 30px;
            text-align: center; box-shadow: 0 0 60px rgba(255, 193, 7, 0.6);
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%; min-width: 300px;
        }
        .result-title { font-size: 1.1rem; color: #757575; text-transform: uppercase; margin-bottom: 5px; }
        .result-name { 
            font-family: 'Anton', sans-serif; font-size: clamp(2rem, 6vw, 3.5rem); 
            color: #D32F2F; line-height: 1.1; text-transform: uppercase; margin-bottom: 10px;
        }
        .result-note { color: #aaa; font-size: 0.8rem; font-style: italic;}

        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes zoomIn { from{transform:scale(0)} to{transform:scale(1)} }

        #music-input { display: none; }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="game-title" contenteditable="true" spellcheck="false">üéÅ TRAO QU√Ä T·∫æT</div>
        <div class="controls-top">
            <button class="btn btn-undo" onclick="undo()" id="btnUndo" disabled>‚Ü©Ô∏è Ho√†n t√°c</button>
            <button class="btn btn-music" onclick="document.getElementById('music-input').click()">üéµ Nh·∫°c</button>
            <button class="btn btn-music" onclick="toggleMusic()" id="btnPlayMusic">‚ñ∂Ô∏è</button>
            <button class="btn btn-settings" onclick="openSettings()">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            <button class="btn btn-full" onclick="toggleFullScreen()">‚õ∂</button>
        </div>
    </div>

    <div class="main-container">
        <div class="gift-area" id="giftContainer">
            <div class="gift-grid" id="giftGrid"></div>
        </div>
        <div class="player-area">
            <div class="player-header">DANH S√ÅCH H·ªò GIA ƒê√åNH</div>
            <div class="player-list" id="playerList"></div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2 style="margin-top:0; color:#D32F2F; text-align:center;">DANH S√ÅCH THAM GIA</h2>
            <p style="text-align:center; color:#666; font-size:0.9rem;">Nh·∫≠p t√™n m·ªói h·ªô tr√™n 1 d√≤ng</p>
            <textarea id="listInput" placeholder="H·ªô A
H·ªô B
H·ªô C..."></textarea>
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
                <button class="btn btn-settings" style="background:#ddd; color:#333" onclick="closeSettings()">ƒê√≥ng</button>
                <button class="btn btn-music" style="background:#D32F2F; padding: 10px 30px;" onclick="saveSettings()">L∆∞u & Ch∆°i M·ªõi</button>
            </div>
        </div>
    </div>

    <div class="result-overlay" id="resultOverlay" onclick="closeResult()">
        <div class="result-box">
            <div class="result-title">M√≥n qu√† ƒë·∫øn t·ª´</div>
            <div class="result-name" id="resultName">H·ªò GIA ƒê√åNH A</div>
            <div class="result-note">(Ch·∫°m m√†n h√¨nh ƒë·ªÉ ƒë√≥ng)</div>
        </div>
        <canvas id="fireworks" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
    </div>

    <input type="file" id="music-input" accept="audio/*, .mp3" onchange="handleFileSelect(this)">
    <audio id="bgAudio" loop></audio>
    <audio id="sfxOpen" src="https://www.myinstants.com/media/sounds/tada_1.mp3"></audio>

    <script>
        let players = []; 
        let gifts = [];   
        let currentPlayerIndex = -1;
        let historyStack = [];

        const giftGrid = document.getElementById('giftGrid');
        const playerList = document.getElementById('playerList');
        const resultOverlay = document.getElementById('resultOverlay');
        const resultName = document.getElementById('resultName');
        const bgAudio = document.getElementById('bgAudio');
        const sfxOpen = document.getElementById('sfxOpen');

        function initGame() {
            const savedList = localStorage.getItem('traoqua_list_v5');
            if (savedList) {
                players = JSON.parse(savedList);
            } else {
                players = Array.from({length: 12}, (_, i) => `H·ªô Gia ƒê√¨nh ${i+1}`);
            }

            gifts = players.map((name, index) => ({
                ownerIndex: index,
                ownerName: name,
                status: 'available', 
                displayOrder: Math.random() 
            }));

            currentPlayerIndex = -1;
            historyStack = [];
            updateUI();
        }

        function updateUI() {
            renderGrid();
            renderPlayerList();
            document.getElementById('btnUndo').disabled = historyStack.length === 0;
        }

        function renderGrid() {
            giftGrid.innerHTML = '';
            const total = gifts.length;
            const container = document.getElementById('giftContainer');
            const cw = container.clientWidth;
            const ch = container.clientHeight;
            let bestCols = Math.ceil(Math.sqrt(total));
            let maxBoxSize = 0;

            for(let c = 1; c <= total; c++) {
                const r = Math.ceil(total / c);
                const w = (cw - (c-1)*15) / c;
                const h = (ch - (r-1)*15) / r;
                const size = Math.min(w, h);
                if(size > maxBoxSize) { maxBoxSize = size; bestCols = c; }
            }
            
            giftGrid.style.gridTemplateColumns = `repeat(${bestCols}, ${maxBoxSize}px)`;
            giftGrid.style.gridTemplateRows = `repeat(${Math.ceil(total/bestCols)}, ${maxBoxSize}px)`;

            const sortedGifts = [...gifts].sort((a, b) => a.displayOrder - b.displayOrder);

            sortedGifts.forEach(gift => {
                const box = document.createElement('div');
                box.className = 'gift-box';
                
                // Set t√™n ch·ªß nh√¢n ƒë·ªÉ hi·ªÉn th·ªã khi ƒë√£ m·ªü (data-owner)
                box.setAttribute('data-owner', gift.ownerName);

                // --- LOGIC CH√åM C·∫¢ 2 ---
                // N·∫øu qu√† n√†y ƒë√£ b·ªã l·∫•y (Taken) -> Ch√¨m
                if (gift.status === 'taken') {
                    box.classList.add('taken');
                }

                // N·∫øu ƒëang ch∆°i m√† ƒë√¢y l√† qu√† c·ªßa m√¨nh -> Kh√≥a
                if (currentPlayerIndex !== -1 && gift.ownerIndex === currentPlayerIndex) {
                    box.classList.add('self-locked');
                    box.title = "Qu√† nh√† m√¨nh!";
                }

                box.onclick = () => handleGiftClick(gift);
                giftGrid.appendChild(box);
            });
        }

        function renderPlayerList() {
            playerList.innerHTML = '';
            players.forEach((name, index) => {
                const btn = document.createElement('div');
                btn.className = 'player-btn';
                
                // Logic V6:
                // Ng∆∞·ªùi ƒë√≥ ƒê√£ b·ªëc qu√† (Picker) -> DONE
                // Ng∆∞·ªùi ƒë√≥ ƒê√£ b·ªã b·ªëc qu√† (Target) -> DONE
                // V√¨ l√† trao ƒë·ªïi ch√©o 1:1, n√™n h·ªÖ d√≠nh v√†o 1 giao d·ªãch l√† XONG LU√îN.
                
                const originalGift = gifts.find(g => g.ownerIndex === index);
                
                // T√¨m xem ng∆∞·ªùi n√†y c√≥ n·∫±m trong l·ªãch s·ª≠ giao d·ªãch kh√¥ng (l√† ng∆∞·ªùi b·ªëc HO·∫∂C ng∆∞·ªùi b·ªã b·ªëc)
                const isParticipated = historyStack.some(h => 
                    h.pickerIndex === index || h.giftOwnerIndex === index
                );

                if (isParticipated) {
                    btn.classList.add('done'); // G·∫°ch t√™n, kh√¥ng cho b·∫•m
                }

                if (index === currentPlayerIndex) {
                    btn.classList.remove('done'); // ƒêang ch∆°i th√¨ ph·∫£i s√°ng
                    btn.classList.add('active');
                }

                let statusIcon = isParticipated ? 'üéÅ‚úÖ' : '';

                btn.innerHTML = `<span>${index + 1}. ${name}</span> <small>${statusIcon}</small>`;
                
                btn.onclick = () => {
                    if (!isParticipated) setPlayer(index);
                };

                playerList.appendChild(btn);
            });
        }

        function setPlayer(index) {
            currentPlayerIndex = index;
            updateUI(); 
        }

        function handleGiftClick(gift) {
            if (currentPlayerIndex === -1) {
                alert("Vui l√≤ng ch·ªçn H·ªô Gia ƒê√¨nh l√™n ch∆°i ·ªü danh s√°ch b√™n ph·∫£i tr∆∞·ªõc!");
                return;
            }
            if (gift.status === 'taken') return; 
            if (gift.ownerIndex === currentPlayerIndex) {
                alert("ƒê√¢y l√† qu√† nh√† m√¨nh m√†! Ch·ªçn h·ªôp kh√°c nh√©!");
                return;
            }

            // Save history
            historyStack.push({
                pickerIndex: currentPlayerIndex,
                giftOwnerIndex: gift.ownerIndex
            });

            // LOGIC QUAN TR·ªåNG V6:
            // 1. Qu√† B·ªã Ch·ªçn (Target Gift) -> TAKEN
            gift.status = 'taken';
            
            // 2. Qu√† C·ªßa Ng∆∞·ªùi Ch·ªçn (Picker Gift) -> C≈®NG TAKEN LU√îN (ƒê·ªÉ kh√¥ng ai ch·ªçn n·ªØa)
            // T√¨m qu√† c·ªßa ng∆∞·ªùi ƒëang ch∆°i
            const pickerGift = gifts.find(g => g.ownerIndex === currentPlayerIndex);
            if (pickerGift) {
                pickerGift.status = 'taken';
            }
            
            showResult(gift.ownerName);
            
            currentPlayerIndex = -1;
            updateUI();
        }

        function undo() {
            if (historyStack.length === 0) return;
            const lastAction = historyStack.pop();
            
            // Kh√¥i ph·ª•c qu√† B (Target)
            const targetGift = gifts.find(g => g.ownerIndex === lastAction.giftOwnerIndex);
            if (targetGift) targetGift.status = 'available';

            // Kh√¥i ph·ª•c qu√† A (Picker)
            const pickerGift = gifts.find(g => g.ownerIndex === lastAction.pickerIndex);
            if (pickerGift) pickerGift.status = 'available';

            currentPlayerIndex = lastAction.pickerIndex;
            updateUI();
        }

        function showResult(name) {
            resultName.innerText = name;
            resultOverlay.classList.add('show');
            sfxOpen.currentTime = 0;
            sfxOpen.play();
            startFireworks();
        }

        function closeResult() {
            resultOverlay.classList.remove('show');
            stopFireworks();
        }

        function openSettings() {
            document.getElementById('listInput').value = players.join('\n');
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings() {
            const text = document.getElementById('listInput').value.trim();
            if (text) {
                const list = text.split('\n').map(s => s.trim()).filter(s => s !== "");
                if (list.length > 0) {
                    localStorage.setItem('traoqua_list_v5', JSON.stringify(list));
                    initGame();
                    closeSettings();
                } else { alert("Danh s√°ch tr·ªëng!"); }
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                bgAudio.src = URL.createObjectURL(file);
                bgAudio.play();
                document.getElementById('btnPlayMusic').innerText = "‚è∏";
            }
        }

        function toggleMusic() {
            if (bgAudio.paused) {
                bgAudio.play();
                document.getElementById('btnPlayMusic').innerText = "‚è∏";
            } else {
                bgAudio.pause();
                document.getElementById('btnPlayMusic').innerText = "‚ñ∂Ô∏è";
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        window.addEventListener('resize', () => { renderGrid(); });

        let fwInterval;
        const canvas = document.getElementById('fireworks');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function startFireworks() {
            const particles = [];
            function createParticle(x, y) {
                const count = 40;
                for (let i = 0; i < count; i++) {
                    particles.push({
                        x: x, y: y,
                        vx: (Math.random() - 0.5) * 15,
                        vy: (Math.random() - 0.5) * 15,
                        life: 1,
                        color: `hsl(${Math.random()*360}, 100%, 60%)`
                    });
                }
            }
            fwInterval = setInterval(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if(Math.random() < 0.1) createParticle(Math.random()*canvas.width, Math.random()*canvas.height/2);
                for (let i = 0; i < particles.length; i++) {
                    let p = particles[i];
                    p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
                    ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                    if (p.life <= 0) particles.splice(i, 1);
                }
            }, 20);
            createParticle(canvas.width/2, canvas.height/2);
        }

        function stopFireworks() {
            clearInterval(fwInterval);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        initGame();

    </script>
</body>
</html>