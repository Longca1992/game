<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vua Ti·∫øng Vi·ªát - V2 (Ch·ªânh Th·ªùi Gian)</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Be+Vietnam+Pro:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --red: #D00000;
            --dark-red: #8B0000;
            --gold: #FFD700;
            --yellow: #FFEB3B;
            --cream: #FFF8E1;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0; height: 100vh;
            font-family: 'Be Vietnam Pro', sans-serif;
            background: radial-gradient(circle at center, var(--red) 0%, var(--dark-red) 100%);
            color: var(--cream);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- M√ÄN H√åNH CHUNG --- */
        .screen {
            display: none; width: 100%; height: 100%;
            flex-direction: column; align-items: center; justify-content: center;
            position: absolute; top: 0; left: 0;
            padding: 20px;
            transition: opacity 0.5s;
        }
        .screen.active { display: flex; z-index: 10; }

        h1 {
            font-family: 'Anton', sans-serif;
            color: var(--gold);
            font-size: clamp(2rem, 5vw, 4rem);
            text-transform: uppercase;
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 20px; text-align: center;
        }

        /* --- N√öT B·∫§M --- */
        button {
            background: linear-gradient(180deg, var(--gold), #FFA000);
            border: 2px solid #fff;
            border-radius: 50px;
            padding: 15px 40px;
            color: #b71c1c;
            font-size: 1.2rem; font-weight: 900;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            margin: 10px;
            text-transform: uppercase;
        }
        button:active { transform: scale(0.95); }
        button.secondary { background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.5); }

        /* --- SETTINGS SCREEN --- */
        .settings-panel {
            background: rgba(0,0,0,0.4);
            padding: 20px; border-radius: 20px;
            width: 95%; max-width: 600px;
            max-height: 85vh; overflow-y: auto;
            border: 2px solid var(--gold);
        }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--gold); }
        input[type="text"], input[type="number"], textarea, input[type="file"] {
            width: 100%; padding: 10px; border-radius: 8px; border: none;
            font-family: inherit; font-size: 1rem;
        }
        textarea { height: 80px; resize: vertical; }
        .row { display: flex; gap: 10px; align-items: center; }
        
        .highlight-input {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid var(--gold) !important;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem !important;
        }

        /* --- GAMEPLAY SCREEN --- */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100;
        }
        .timer-text {
            font-family: 'Anton'; font-size: 5rem; color: #fff;
            text-shadow: 0 0 20px var(--red);
            margin: 20px 0;
        }
        .word-display {
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 900;
            color: var(--gold);
            text-shadow: 3px 3px 0 #8B0000, -1px -1px 0 #fff;
            letter-spacing: 5px;
            text-align: center;
            line-height: 1.4;
            background: rgba(0,0,0,0.2);
            padding: 20px; border-radius: 20px;
            border: 2px dashed rgba(255,215,0,0.3);
            width: 95%;
        }
        
        .result-area {
            display: none; flex-direction: column; align-items: center;
            margin-top: 20px;
            animation: popIn 0.5s;
        }
        .correct-answer {
            font-size: 2rem; color: #4CAF50;
            background: #fff; padding: 10px 30px;
            border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }

        /* --- POPUP LEVEL --- */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .popup-content {
            text-align: center;
            animation: zoomIn 0.5s;
        }
        .level-title { font-size: 2rem; color: #aaa; margin-bottom: 10px; }
        .level-number { font-size: 8rem; font-family: 'Anton'; color: var(--gold); margin: 0; line-height: 1; }
        
        /* Animations */
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes zoomIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulseRed { 0% { transform: scale(1); color: #fff; } 50% { transform: scale(1.2); color: #ff0000; } 100% { transform: scale(1); color: #fff; } }
        
        .urgent { animation: pulseRed 0.5s infinite; }

        /* Audio Controls */
        .audio-controls {
            display: flex; gap: 10px; align-items: center;
            background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 20px;
        }
        input[type=range] { width: 80px; }

    </style>
</head>
<body>

    <div id="screen-setup" class="screen active">
        <h1>VUA TI·∫æNG VI·ªÜT 2025</h1>
        <div class="settings-panel">
            
            <div class="control-group">
                <label>‚è±Ô∏è TƒÉng th√™m th·ªùi gian cho T·∫§T C·∫¢ c√¢u h·ªèi (Gi√¢y):</label>
                <input type="number" id="time-offset" class="highlight-input" value="5" placeholder="Nh·∫≠p s·ªë gi√¢y mu·ªën c·ªông th√™m (VD: 5)">
                <div style="font-size: 0.8rem; color: #ccc; margin-top: 5px;">*S·ªë n√†y s·∫Ω c·ªông v√†o th·ªùi gian g·ªëc c·ªßa t·ª´ng c√¢u h·ªèi.</div>
            </div>

            <div class="control-group">
                <label>üéµ Nh·∫°c n·ªÅn (MP3/Online):</label>
                <input type="file" id="bg-music-file" accept="audio/*, .mp3">
                <div style="text-align: center; margin: 5px 0; font-size: 0.8rem;">HO·∫∂C D√°n Link Online</div>
                <input type="text" id="bg-music-url" placeholder="https://example.com/music.mp3">
            </div>

            <div class="control-group">
                <label>üìù N·ªôi dung th√™m (T·ª´ - Gi√¢y):</label>
                <textarea id="custom-words" placeholder="V√≠ d·ª•:
Vi·ªát Nam V√¥ ƒê·ªãch - 15
Ch√∫c M·ª´ng NƒÉm M·ªõi - 10"></textarea>
            </div>

            <div class="control-group row">
                <input type="checkbox" id="use-default" checked style="width: 20px; height: 20px;">
                <label for="use-default" style="margin:0; cursor:pointer;">S·ª≠ d·ª•ng b·ªô t·ª´ m·∫∑c ƒë·ªãnh?</label>
            </div>

            <button onclick="initGame()" style="width: 100%">B·∫ÆT ƒê·∫¶U TR√í CH∆†I</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="top-bar">
            <div class="audio-controls">
                <span id="music-icon">üîä</span>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
            </div>
            <button class="secondary" onclick="toggleFullScreen()" style="padding: 5px 15px; font-size: 0.9rem;">‚õ∂ Full</button>
        </div>

        <h2 style="color: rgba(255,255,255,0.5); margin-top: 40px; margin-bottom: 5px;" id="q-counter">C√¢u h·ªèi 1</h2>
        <div class="timer-text" id="timer-display">10</div>
        
        <div class="word-display" id="word-display">
            </div>

        <div class="result-area" id="result-area">
            <div style="font-size: 1rem; color: #aaa; margin-bottom: 5px;">ƒê√ÅP √ÅN L√Ä:</div>
            <div class="correct-answer" id="correct-answer">TH√ÅI ƒê·ªò</div>
            <button onclick="nextQuestion()">C√ÇU TI·∫æP THEO ‚ûú</button>
        </div>
    </div>

    <div class="popup-overlay" id="popup-overlay" onclick="startLevelTimer()">
        <div class="popup-content">
            <div class="level-title">C√ÇU H·ªéI S·ªê</div>
            <div class="level-number" id="popup-num">1</div>
            <div style="margin-top: 20px; font-size: 1.2rem; color: #fff;">T·ª´ n√†y l√† t·ª´ g√¨?</div>
            <div style="margin-top: 30px; font-size: 0.9rem; color: var(--yellow); opacity: 0.7;">(Ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ b·∫Øt ƒë·∫ßu)</div>
        </div>
    </div>

    <audio id="bg-audio" loop></audio>
    
    <script>
        // --- DATA ---
        const defaultData = [
            { a: "Th√°i ƒê·ªô", s: "ƒë/√°/i/h/·ªô/t", t: 7 },
            { a: "Ki·ªÉm So√°t", s: "m/√°/t/s/i/k/·ªÉ/o", t: 15 },
            { a: "Khai M·∫°c", s: "c/·∫°/m/h/a/i/k", t: 10 },
            { a: "Thanh to√°n", s: "h/o/n/√°/t/t/h/a/n", t: 10 },
            { a: "√Çm Nhac", s: "n/h/√¢/m/c/·∫°", t: 7 },
            { a: "Ph√†n n√†n", s: "n/h/√†/p/√†/n/n", t: 10 },
            { a: "Gi√°o vi√™n", s: "g/i/√™/n/v/√°/o/i", t: 10 },
            { a: "Vi·ªác L√†m", s: "v/·ªá/c/i/m/√†/l", t: 7 },
            { a: "X√¢y d·ª±ng", s: "n/g/·ª±/√¢/d/x", t: 10 },
            { a: "Nh·ªôn Nh·ªãp", s: "n/·ªô/n/p/·ªã/n/h/h", t: 7 },
            { a: "B·ªÅ Th·∫ø", s: "b/·∫ø/h/·ªÅ/t", t: 7 },
            { a: "B·∫£n ƒë·ªãa", s: "b/·ªã/a/n/·∫£/ƒë", t: 7 },
            { a: "Im l√¨m", s: "m/√¨/m/i/l", t: 7 },
            { a: "Kh√°m x√©t", s: "m/√°/t/x/√©/h/k", t: 10 },
            { a: "T√†i s·∫£n", s: "s/i/√†/n/·∫£/t", t: 7 }
        ];

        const extraDataRaw = [
            { a: "Vi·ªát Nam ƒê·ªãnh", t: 15 },
            { a: "X√≥m 54/92", t: 7 },
            { a: "√çt Nh·∫≠u Th√¥i", t: 12 },
            { a: "ƒê√°nh Pickleball", t: 12 },
            { a: "X√≥m vƒÉn minh", t: 15 },
            { a: "T·∫øt May M·∫Øn", t: 15 },
            { a: "T√¨nh L√†ng Nghƒ©a X√≥m", t: 25 },
            { a: "Gia ƒê√¨nh", t: 7 },
            { a: "H·∫°nh Ph√∫c", t: 7 },
            { a: "Ph√°t T√†i", t: 7 },
            { a: "NƒÉm M·ªõi", t: 7 },
            { a: "M·∫°nh Kho·∫ª", t: 10 }
        ];

        let gameData = [];
        let currentIndex = 0;
        let timerInterval;
        let timeLeft = 0;
        let audioCtx; // For tick sound

        // --- UTILS ---
        function scrambleWord(word) {
            let chars = word.replace(/\s+/g, '').split('');
            for (let i = chars.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [chars[i], chars[j]] = [chars[j], chars[i]];
            }
            return chars.join('/').toLowerCase();
        }

        function createTickSound() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.value = 800; // Hz
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- GAME LOGIC ---
        function initGame() {
            gameData = [];
            const useDefault = document.getElementById('use-default').checked;
            
            // L·∫•y gi√° tr·ªã th·ªùi gian c·ªông th√™m (m·∫∑c ƒë·ªãnh 0 n·∫øu kh√¥ng nh·∫≠p)
            const timeOffset = parseInt(document.getElementById('time-offset').value) || 0;

            // X·ª≠ l√Ω b·ªô t·ª´ m·∫∑c ƒë·ªãnh
            if (useDefault) {
                defaultData.forEach(item => {
                    gameData.push({
                        a: item.a,
                        s: item.s,
                        t: (item.t + timeOffset) > 0 ? (item.t + timeOffset) : 5 // ƒê·∫£m b·∫£o t·ªëi thi·ªÉu 5s
                    });
                });
            }

            // X·ª≠ l√Ω b·ªô t·ª´ b·ªï sung
            extraDataRaw.forEach(item => {
                gameData.push({
                    a: item.a,
                    s: scrambleWord(item.a),
                    t: (item.t + timeOffset) > 0 ? (item.t + timeOffset) : 5
                });
            });

            // X·ª≠ l√Ω b·ªô t·ª´ custom nh·∫≠p tay
            const customText = document.getElementById('custom-words').value.trim();
            if (customText) {
                const lines = customText.split('\n');
                lines.forEach(line => {
                    const parts = line.split('-');
                    if (parts.length >= 1) {
                        const word = parts[0].trim();
                        let time = parts[1] ? parseInt(parts[1].trim()) : 10;
                        
                        // C·ªông th√™m th·ªùi gian offset
                        time = (time + timeOffset) > 0 ? (time + timeOffset) : 5;

                        gameData.push({
                            a: word,
                            s: scrambleWord(word),
                            t: time
                        });
                    }
                });
            }

            if (gameData.length === 0) {
                alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ngu·ªìn d·ªØ li·ªáu!");
                return;
            }

            // X√°o tr·ªôn th·ª© t·ª± c√¢u h·ªèi
            gameData.sort(() => Math.random() - 0.5);

            // Setup Audio
            const fileInput = document.getElementById('bg-music-file');
            const urlInput = document.getElementById('bg-music-url');
            const audioEl = document.getElementById('bg-audio');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                audioEl.src = URL.createObjectURL(file);
            } else if (urlInput.value) {
                audioEl.src = urlInput.value;
            } else {
                // Fallback link nh·∫°c online
                audioEl.src = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"; 
            }
            audioEl.volume = 0.5;

            // Switch Screen
            document.getElementById('screen-setup').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            currentIndex = 0;
            showPopup();
        }

        function showPopup() {
            const popup = document.getElementById('popup-overlay');
            document.getElementById('popup-num').innerText = currentIndex + 1;
            popup.style.display = 'flex';
            
            // Play background music
            const bgAudio = document.getElementById('bg-audio');
            if (bgAudio.paused && bgAudio.src) {
                bgAudio.play().catch(e => console.log("Audio play blocked until interaction"));
            }
        }

        function startLevelTimer() {
            document.getElementById('popup-overlay').style.display = 'none';
            
            const currentItem = gameData[currentIndex];
            document.getElementById('q-counter').innerText = `C√¢u h·ªèi ${currentIndex + 1} / ${gameData.length}`;
            document.getElementById('word-display').innerText = currentItem.s;
            document.getElementById('correct-answer').innerText = currentItem.a;
            
            document.getElementById('result-area').style.display = 'none';
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.classList.remove('urgent');
            timerDisplay.style.color = "#fff";

            // Timer Logic
            timeLeft = currentItem.t;
            timerDisplay.innerText = timeLeft;
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;

                if (timeLeft <= 3 && timeLeft > 0) {
                    timerDisplay.classList.add('urgent');
                    timerDisplay.style.color = "var(--red)";
                    createTickSound();
                }

                if (timeLeft <= 0) {
                    endLevel();
                }
            }, 1000);
        }

        function endLevel() {
            clearInterval(timerInterval);
            document.getElementById('timer-display').innerText = "H·∫æT GI·ªú!";
            document.getElementById('timer-display').classList.remove('urgent');
            document.getElementById('result-area').style.display = 'flex';
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < gameData.length) {
                showPopup();
            } else {
                alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi.");
                location.reload();
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        document.getElementById('volume-slider').addEventListener('input', function(e) {
            const audio = document.getElementById('bg-audio');
            audio.volume = e.target.value;
            if(e.target.value == 0) document.getElementById('music-icon').innerText = 'üîá';
            else document.getElementById('music-icon').innerText = 'üîä';
        });

    </script>
</body>
</html>