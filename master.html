<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>T√∫i V√†ng 2025 - Fix Nh·∫°c iPad</title>
  <style>
    :root{
      --bg1:#8b0000;
      --bg2:#2a0000;
      --gold:#ffd36a;
      --gold2:#ffb300;
      --text:#fff5dd;
      --muted:#ffdca8cc;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      color:var(--text);
      height:100vh;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(255,211,106,.20), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(255,179,0,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; overflow:hidden; }

    header{
      padding: 8px 14px;
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
      max-width: 1200px; width:100%; margin: 0 auto; flex: 0 0 auto;
    }
    .title h1{
      margin:0; font-size: clamp(16px, 2vw, 24px);
      color: var(--gold); text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .title p{ margin:0; color:var(--muted); font-size:12px; }

    .badge{
      display:flex; align-items:center; gap:10px;
      background: rgba(0,0,0,.3); border: 1px solid rgba(255,211,106,.35);
      padding: 6px 12px; border-radius: 12px; min-width: 180px;
      justify-content: space-between; flex:0 0 auto;
    }
    .badge .val{ font-weight: 900; color: var(--gold); font-size: 1.1em;}
    
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px; border-radius: 20px;
      background: rgba(0,0,0,.2); border: 1px solid rgba(255,211,106,.2);
      color: var(--muted); font-size: 11px; font-weight: 700;
    }
    .pill b{ color: var(--gold); }

    main{
      flex:1; min-height:0;
      max-width: 1200px; width:100%; margin: 0 auto;
      padding: 0 10px 10px;
      display:grid;
      grid-template-columns: 1fr 320px;
      gap: 10px; overflow:hidden;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
      .badge{ display: none; }
      .panel:last-child { max-height: 45vh; } 
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.3));
      border: 1px solid rgba(255,211,106,.2); border-radius: 16px;
      box-shadow: var(--shadow); overflow:hidden;
      display:flex; flex-direction:column;
      height: 100%;
    }
    .panel .head{
      padding: 8px 12px; display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(255,211,106,.15);
      background: rgba(0,0,0,.2); flex:0 0 auto;
    }
    .panel .head .h{ font-weight: 900; color: #fff; font-size: 14px;}

    .gridWrap{ 
        padding: 10px; flex:1; min-height:0; 
        display:flex; justify-content: center; align-items: center; 
        overflow: hidden;
    }
    
    .grid{
      display:grid;
      gap: 0.5vh;
      width: 100%; height: 100%;
      align-content: center; justify-content: center;
    }

    .cell{
      position:relative; border-radius: 8px;
      display:flex; align-items:center; justify-content:center;
      font-family: 'Arial', sans-serif; font-weight: 900;
      font-size: clamp(10px, 2.5vh, 24px); 
      color: #fff; 
      text-shadow: 2px 2px 0 #000;
      background-image: url('https://cdn.hstatic.net/files/200000273197/file/tui-vang.png');
      background-size: contain; background-repeat: no-repeat; background-position: center;
      aspect-ratio: 1/1; 
      width: 100%; height: auto; max-height: 100%;
      transition: transform .1s;
    }
    
    .cell.used{ opacity: 0.3; filter: grayscale(1); }
    .cell.active{ transform: scale(1.3); z-index: 100; filter: drop-shadow(0 0 20px gold); }

    .controls{ padding: 10px; display:flex; flex-direction:column; gap: 8px; overflow-y: auto; height: 100%;}
    .block{
      display:flex; flex-direction:column; gap:8px; padding: 10px;
      border-radius: 12px; background: rgba(0,0,0,.3); border: 1px solid rgba(255,211,106,.1);
      flex-shrink: 0;
    }

    .prizeBox{ text-align: center; }
    .prizeName{ font-size: 18px; font-weight: 1000; color: var(--gold); text-transform: uppercase; margin: 4px 0; }

    button{
      appearance:none; border:none; border-radius: 10px; padding: 10px;
      font-weight: 800; font-size: 14px; text-transform: uppercase;
      cursor:pointer; transition: all .2s;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:active{ transform: scale(.98); }
    button:disabled{ opacity: 0.5; cursor: not-allowed; }

    #btnSpin{
      background: linear-gradient(180deg, #ffeb3b, #fbc02d);
      color: #b71c1c; font-size: 18px; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
      padding: 14px; flex-shrink: 0;
    }
    
    .btnSecondary{ background: rgba(255,255,255,0.1); color: #ddd; border: 1px solid rgba(255,255,255,0.2); width: 100%; }
    .btnDanger{ background: rgba(244, 67, 54, 0.2); color: #ff8a80; border: 1px solid rgba(244, 67, 54, 0.4); width: 100%; }

    /* CUSTOM FILE INPUT CHO IPAD */
    .file-row { display: flex; gap: 5px; align-items: center; }
    .file-upload-btn {
        position: relative; overflow: hidden;
        background: #333; color: #fff; border: 1px dashed var(--gold);
        padding: 8px; border-radius: 8px; font-size: 11px; text-align: center;
        flex: 1; cursor: pointer;
    }
    .file-upload-btn input[type=file] {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0; cursor: pointer;
    }
    #btnTestMusic { width: auto; padding: 8px 12px; font-size: 12px; background: var(--green); color: white; border: none;}
    #fileNameDisplay { font-size: 11px; color: var(--green); font-style: italic; display: none; }

    .input-row { display: flex; gap: 5px; }
    input[type="number"]{
        flex: 1; padding: 8px; border-radius: 8px; border: none; font-weight: bold; text-align: center;
    }

    .log{
      flex:1; min-height: 0; background: rgba(0,0,0,.2);
      border-radius: 12px; padding: 8px; overflow-y: auto;
    }
    .logItem{
      display:flex; justify-content:space-between; align-items: center;
      padding: 6px 8px; margin-bottom: 4px;
      background: rgba(255,255,255,0.05); border-radius: 6px;
    }
    .logItem .num{ font-size: 16px; font-weight: bold; color: #fff; }

    /* OVERLAY */
    .overlay{
      position: fixed; inset: 0; background: rgba(0,0,0,0.9);
      backdrop-filter: blur(5px); z-index: 200;
      display:none; align-items:center; justify-content:center;
    }
    .overlay.show{ display:flex; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    .resultCard{
      background: url('https://cdn.hstatic.net/files/200000273197/file/tui-vang.png') no-repeat center center;
      background-size: contain; width: 90vw; max-width: 500px; aspect-ratio: 1/1;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      position: relative; filter: drop-shadow(0 0 50px gold);
      animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes zoomIn { from{transform:scale(0)} to{transform:scale(1)} }

    .resultTitle{ font-size: clamp(20px, 4vw, 30px); color: #fff; text-shadow: 2px 2px 4px #000; position: absolute; top: 22%; font-weight: bold; text-transform: uppercase;}
    .resultNum{ font-size: clamp(80px, 15vw, 140px); color: #fff; text-shadow: 4px 4px 0 #000; margin-top: 30px; font-weight: 900; }
    
    .closeBtn {
        position: absolute; bottom: 10%; background: #fff; color: #000; 
        border: none; padding: 10px 30px; border-radius: 30px; font-weight: bold; 
        font-size: 16px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .toast{
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: #333; color: #fff; padding: 10px 20px; border-radius: 30px;
      opacity: 0; transition: 0.3s; pointer-events: none; z-index: 300; font-weight: bold;
      border: 1px solid var(--gold); white-space: nowrap;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }

  </style>
</head>

<body>
  <div class="app" id="appContainer">
    <header>
      <div class="title">
        <h1>üßß L√å X√å T√öI V√ÄNG 2025</h1>
        <p>T·∫•t Ni√™n X√≥m 54/92</p>
      </div>
      <div class="badge">
        <div><div class="lbl">S·∫ÆP QUAY</div><div class="val" id="nextPrize">...</div></div>
        <div class="pill">C√≤n: <b id="remain">100</b></div>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="head">
          <div class="h">DANH S√ÅCH T√öI V√ÄNG <span id="rangeLabel" style="font-weight:normal; opacity:0.7; font-size:0.9em">(1-100)</span></div>
          <button id="btnFullscreen" class="btnSecondary" style="width: auto; padding: 4px 10px; font-size: 12px;">‚õ∂ Full</button>
        </div>
        <div class="gridWrap">
          <div class="grid" id="grid"></div>
        </div>
      </section>

      <aside class="panel">
        <div class="head"><div class="h">B·∫¢NG ƒêI·ªÄU KHI·ªÇN</div></div>
        <div class="controls">
          
          <div class="block prizeBox">
            <div class="hint">ƒêang quay gi·∫£i</div>
            <div class="prizeName" id="prizeName">---</div>
            <div class="pill">V√≤ng: <b id="spinIndex">1/4</b></div>
          </div>

          <button id="btnSpin">üé° QUAY TH∆Ø·ªûNG (10s)</button>

          <div class="block">
            <label style="color:var(--gold); font-size:12px; font-weight:bold; margin-bottom:5px; display:block;">üéµ Nh·∫°c n·ªÅn MP3 (T√πy ch·ªçn)</label>
            <div class="file-row">
                <div class="file-upload-btn">
                    <span>üìÇ Ch·ªçn file MP3...</span>
                    <input type="file" id="audioFile" accept=".mp3,audio/*">
                </div>
                <button id="btnTestMusic">‚ñ∂Ô∏è Test</button>
            </div>
            <div id="fileNameDisplay"></div>
            <div style="font-size:10px; color:#999; margin-top:4px;">* iPad: Ch·ªçn "Duy·ªát" (Browse) > Ch·ªçn file trong m√°y.</div>
          </div>

          <div class="block">
            <div class="input-row">
              <input id="countInput" type="number" value="100" placeholder="S·ªë ng∆∞·ªùi" />
              <button id="btnApplyCount" class="btnSecondary" style="width: auto;">ƒê·ªïi</button>
            </div>
            <div style="margin-top:8px; display:flex; justify-content:space-between; font-size:12px; color:#ccc;">
                <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" id="chkNoRepeat" checked> 1 Ng∆∞·ªùi/1 L·∫ßn</label>
                <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" id="chkSound" checked> T√≠t t√≠t</label>
            </div>
          </div>

          <div class="input-row">
            <button id="btnUndo" class="btnSecondary" disabled>‚Ü©Ô∏è Ho√†n t√°c</button>
            <button id="btnReset" class="btnDanger">üß® Reset</button>
          </div>

          <div class="log" id="log"></div>
        </div>
      </aside>
    </main>
  </div>

  <div class="overlay" id="overlay">
    <div class="resultCard">
      <div class="resultTitle" id="resultTitle">GI·∫¢I NH·∫§T</div>
      <div class="resultNum" id="resultNum">00</div>
      <button class="closeBtn" id="btnCloseOverlay">ƒê√≥ng l·∫°i</button>
    </div>
    <canvas id="fxCanvas" style="position:absolute; inset:0; pointer-events:none;"></canvas>
  </div>

  <div class="toast" id="toast">Th√¥ng b√°o</div>

<script>
(() => {
  // === C·∫§U H√åNH ===
  const PRIZES = ["Gi·∫£i 3", "Gi·∫£i Nh√¨", "Gi·∫£i Nh·∫•t", "Gi·∫£i ƒê·∫∑c Bi·ªát"];
  const SPIN_DURATION_MS = 10000; 
  // >>> ƒêI·ªÄN T√äN FILE NH·∫†C C·ª¶A B·∫†N ·ªû ƒê√ÇY N·∫æU UP L√äN GITHUB (Vd: './nhacnen.mp3') <<<
  const DEFAULT_MUSIC_URL = ''; 

  // VARS
  let spinCount = 0;
  let isSpinning = false;
  let maxNumber = 100;
  let activeIndex = 0;
  let used = new Set();
  let history = [];
  let userAudio = null; 

  // DOM
  const gridEl = document.getElementById('grid');
  const btnSpin = document.getElementById('btnSpin');
  const btnReset = document.getElementById('btnReset');
  const btnUndo = document.getElementById('btnUndo');
  const btnFullscreen = document.getElementById('btnFullscreen');
  
  const prizeNameEl = document.getElementById('prizeName');
  const nextPrizeEl = document.getElementById('nextPrize');
  const spinIndexEl = document.getElementById('spinIndex');
  const logEl = document.getElementById('log');
  const remainEl = document.getElementById('remain');
  
  const audioFileInput = document.getElementById('audioFile');
  const btnTestMusic = document.getElementById('btnTestMusic');
  const fileNameDisplay = document.getElementById('fileNameDisplay');

  const countInput = document.getElementById('countInput');
  const btnApplyCount = document.getElementById('btnApplyCount');
  const chkNoRepeat = document.getElementById('chkNoRepeat');
  const chkSound = document.getElementById('chkSound');

  const overlay = document.getElementById('overlay');
  const resultTitle = document.getElementById('resultTitle');
  const resultNum = document.getElementById('resultNum');
  const btnCloseOverlay = document.getElementById('btnCloseOverlay');
  const fxCanvas = document.getElementById('fxCanvas');
  const fxCtx = fxCanvas.getContext('2d');

  // --- AUDIO LOGIC (FIX FOR IPAD) ---
  if(DEFAULT_MUSIC_URL) {
      userAudio = new Audio(DEFAULT_MUSIC_URL);
      userAudio.loop = true;
  }

  audioFileInput.addEventListener('change', function(e){
      const file = e.target.files[0];
      if(file){
          if(userAudio) { userAudio.pause(); }
          userAudio = new Audio(URL.createObjectURL(file));
          userAudio.loop = true; 
          fileNameDisplay.textContent = "ƒê√£ ch·ªçn: " + file.name;
          fileNameDisplay.style.display = "block";
          toast("ƒê√£ n·∫°p nh·∫°c th√†nh c√¥ng!");
          
          // Reset n√∫t test
          btnTestMusic.innerText = "‚ñ∂Ô∏è Test";
      }
  });

  // N√∫t Test nh·∫°c ri√™ng bi·ªát
  btnTestMusic.addEventListener('click', () => {
      if(!userAudio) {
          toast("Ch∆∞a ch·ªçn file nh·∫°c!");
          return;
      }
      if(userAudio.paused) {
          userAudio.currentTime = 0;
          userAudio.play().then(() => {
              btnTestMusic.innerText = "‚è∏ D·ª´ng";
          }).catch(err => {
              toast("L·ªói ph√°t nh·∫°c (iOS ch·∫∑n auto-play?)");
          });
      } else {
          userAudio.pause();
          btnTestMusic.innerText = "‚ñ∂Ô∏è Test";
      }
  });

  function playMusic(){
      if(userAudio){
          userAudio.currentTime = 0;
          userAudio.play().catch(err => console.log("L·ªói ph√°t nh·∫°c:", err));
      }
  }
  function stopMusic(){ if(userAudio) userAudio.pause(); }

  // --- GRID & FIT SCREEN LOGIC ---
  function computeLayout(n) {
      const container = document.querySelector('.gridWrap');
      const w = container.clientWidth;
      const h = container.clientHeight;
      let bestCols = Math.ceil(Math.sqrt(n));
      let maxSize = 0;
      const start = Math.max(1, Math.floor(Math.sqrt(n)) - 2);
      const end = Math.min(n, Math.ceil(Math.sqrt(n)) + 5);

      for (let c = start; c <= end; c++) {
          const r = Math.ceil(n / c);
          const sizeW = (w - (c + 1) * 5) / c; 
          const sizeH = (h - (r + 1) * 5) / r; 
          const size = Math.min(sizeW, sizeH);
          if (size > maxSize) { maxSize = size; bestCols = c; }
      }
      return bestCols;
  }

  function buildGrid(n){
    gridEl.innerHTML = '';
    const cols = computeLayout(n);
    gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    
    for(let i=1; i<=n; i++){
      const d = document.createElement('div');
      d.className = 'cell';
      d.textContent = i;
      d.dataset.n = String(i);
      gridEl.appendChild(d);
    }
    
    activeIndex = Math.floor(Math.random()*n);
    setActive(activeIndex);
    updateUI();
  }
  
  window.addEventListener('resize', () => { buildGrid(maxNumber); });

  function setActive(idx){
    const cells = gridEl.querySelectorAll('.cell');
    if(!cells.length) return;
    idx = ((idx % cells.length) + cells.length) % cells.length;
    cells[activeIndex]?.classList.remove('active');
    activeIndex = idx;
    cells[activeIndex]?.classList.add('active');
  }

  function getCells(){ return gridEl.querySelectorAll('.cell'); }

  function updateUI(){
    const idx = Math.min(spinCount, PRIZES.length - 1);
    const isDone = spinCount >= PRIZES.length;
    
    prizeNameEl.textContent = isDone ? "ƒê√É TRAO H·∫æT GI·∫¢I" : PRIZES[idx];
    nextPrizeEl.textContent = PRIZES[Math.min(spinCount + 1, PRIZES.length - 1)] || "...";
    spinIndexEl.textContent = `${Math.min(spinCount + 1, PRIZES.length)} / ${PRIZES.length}`;
    remainEl.textContent = maxNumber - used.size;

    btnUndo.disabled = history.length === 0 || isSpinning;
    btnSpin.disabled = isSpinning || (chkNoRepeat.checked && used.size >= maxNumber) || isDone;

    getCells().forEach(c => {
        const n = Number(c.dataset.n);
        c.classList.toggle('used', used.has(n));
    });
    document.getElementById('rangeLabel').textContent = `(1 - ${maxNumber})`;
  }

  function addLog(item){
      const d = document.createElement('div');
      d.className = 'logItem';
      d.innerHTML = `<div><div style="color:var(--gold);font-weight:bold">${item.prize}</div><div style="font-size:10px;color:#aaa">${item.time}</div></div><div style="font-size:16px;font-weight:bold;color:#fff">#${item.number}</div>`;
      logEl.prepend(d);
  }

  // --- AUDIO SFX ---
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioCtx = new AudioContext();
  
  function beep(freq = 800, dur = 0.05){
      if(!chkSound.checked) return;
      if(audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = freq;
      osc.type = 'square';
      gain.gain.value = 0.1;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + dur);
  }

  // --- SPIN LOGIC ---
  async function spin(){
      if(isSpinning) return;
      
      const cells = getCells();
      let available = [];
      cells.forEach((c, i) => {
          if(!used.has(Number(c.dataset.n))) available.push(i);
      });
      
      if(chkNoRepeat.checked && available.length === 0){
          toast("ƒê√£ h·∫øt s·ªë ƒë·ªÉ quay!");
          return;
      }

      isSpinning = true;
      btnSpin.disabled = true;
      
      // B·∫≠t nh·∫°c (n·∫øu c√≥)
      try { playMusic(); } catch(e){}

      let targetIndex;
      if(chkNoRepeat.checked){
          targetIndex = available[Math.floor(Math.random() * available.length)];
      } else {
          targetIndex = Math.floor(Math.random() * cells.length);
      }

      const totalTime = SPIN_DURATION_MS; 
      let currentTime = 0;
      let delay = 50;
      
      while(currentTime < totalTime){
          let nextIdx = Math.floor(Math.random() * cells.length);
          setActive(nextIdx);
          beep(1000, 0.03); 
          
          let progress = currentTime / totalTime;
          if(progress < 0.7){ delay = 50; } 
          else { delay = 50 + (progress - 0.7) * 1000; }

          await new Promise(r => setTimeout(r, delay));
          currentTime += delay;
      }

      setActive(targetIndex);
      try { stopMusic(); } catch(e){}
      beep(600, 0.6); 

      const finalNum = Number(cells[targetIndex].dataset.n);
      used.add(finalNum);
      
      const currentPrize = PRIZES[Math.min(spinCount, PRIZES.length-1)];
      const historyItem = { prize: currentPrize, number: finalNum, time: new Date().toLocaleTimeString('vi-VN'), idx: targetIndex };
      history.push(historyItem);
      addLog(historyItem);
      
      spinCount++;
      isSpinning = false;
      updateUI();
      
      setTimeout(() => showResult(currentPrize, finalNum), 500);
  }

  // --- FULLSCREEN ---
  btnFullscreen.addEventListener('click', () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(e=>{});
        btnFullscreen.innerText = "Tho√°t";
    } else {
        if (document.exitFullscreen) document.exitFullscreen();
        btnFullscreen.innerText = "Full";
    }
  });

  // --- RESULT OVERLAY ---
  let fwInterval;
  function showResult(prize, num){
      resultTitle.textContent = prize;
      resultNum.textContent = num;
      overlay.classList.add('show');
      startFireworks();
  }
  btnCloseOverlay.addEventListener('click', () => {
      overlay.classList.remove('show');
      stopFireworks();
  });

  function startFireworks() {
      const w = fxCanvas.width = fxCanvas.offsetWidth;
      const h = fxCanvas.height = fxCanvas.offsetHeight;
      const particles = [];
      
      function createParticle(x, y) {
          const count = 30;
          for(let i=0; i<count; i++){
              const angle = Math.random() * Math.PI * 2;
              const speed = Math.random() * 5 + 2;
              particles.push({ x: x, y: y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 1, color: `hsl(${Math.random()*360}, 100%, 50%)` });
          }
      }
      fwInterval = setInterval(() => createParticle(Math.random()*w, Math.random()*h/2), 800);
      createParticle(w/2, h/2);

      function update() {
          if(!overlay.classList.contains('show')) return;
          fxCtx.clearRect(0,0,w,h);
          for(let i=0; i<particles.length; i++){
              let p = particles[i];
              p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life -= 0.02;
              fxCtx.globalAlpha = p.life; fxCtx.fillStyle = p.color;
              fxCtx.beginPath(); fxCtx.arc(p.x, p.y, 3, 0, Math.PI*2); fxCtx.fill();
              if(p.life <= 0) { particles.splice(i, 1); i--; }
          }
          requestAnimationFrame(update);
      }
      update();
  }
  function stopFireworks(){ clearInterval(fwInterval); fxCtx.clearRect(0,0, fxCanvas.width, fxCanvas.height); }

  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }

  btnApplyCount.addEventListener('click', () => {
      let val = parseInt(countInput.value);
      if(val < 1) val = 1;
      maxNumber = val;
      used.clear(); history = []; spinCount = 0; logEl.innerHTML = '';
      buildGrid(maxNumber);
      toast("ƒê√£ c·∫≠p nh·∫≠t!");
  });

  btnReset.addEventListener('click', () => {
      if(confirm("Ch·∫Øc ch·∫Øn Reset?")){
          used.clear(); history = []; spinCount = 0; logEl.innerHTML = '';
          updateUI(); toast("ƒê√£ Reset!");
      }
  });

  btnUndo.addEventListener('click', () => {
      if(!history.length) return;
      const last = history.pop();
      used.delete(last.number); spinCount--;
      logEl.removeChild(logEl.firstChild);
      updateUI(); toast(`ƒê√£ ho√†n t√°c s·ªë ${last.number}`);
  });

  btnSpin.addEventListener('click', spin);

  // Init
  buildGrid(100);
})();
</script>
</body>
</html>
