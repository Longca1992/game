<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>100 √î Lucky - H·∫£i S·∫£n K·ª≥ H√† 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary-red:#b71c1c;
      --gold:#ffd700;
      --bg-pattern:#880e4f;
      --card-back:#d32f2f;
      --text-gold:#fbc02d;

      --safe-top: env(safe-area-inset-top);
      --safe-right: env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      font-family:'Roboto',sans-serif;
      background: radial-gradient(circle, var(--primary-red), var(--bg-pattern));
      color:#fff;
      margin:0;
      min-height:100dvh;
      display:flex;
      flex-direction:row;
      overflow-x:hidden; /* FIX s·ªçc/scroll ngang */
      padding: calc(8px + var(--safe-top)) calc(8px + var(--safe-right)) calc(8px + var(--safe-bottom)) calc(8px + var(--safe-left));
      gap:10px;
    }

    /* --- GAME AREA --- */
    .game-area{
      flex:1;
      min-width:0;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .grid-container{
      display:grid;
      gap:5px;
      width:min(100%, 920px);
      height: min(calc(100dvh - 16px - var(--safe-top) - var(--safe-bottom)), 920px);
      aspect-ratio:1/1;
      perspective:1000px;
      touch-action: manipulation;
    }

    .card{
      background:transparent;
      cursor:pointer;
      position:relative;
      transform-style:preserve-3d;
      transition:transform .55s cubic-bezier(.4,.2,.2,1);
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.35);
      width:100%; height:100%;
      will-change: transform;
    }
    .card.flipped{ transform: rotateY(180deg); cursor:default; }
    .card-face{
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      border-radius:6px;
      border:1px solid rgba(255,215,0,.9);
      user-select:none;
      overflow:hidden;
      padding:2px;
    }
    .card-front{
      background: linear-gradient(135deg, var(--card-back), #8e0000);
      color: var(--gold);
      font-size: clamp(.9rem, 2.2vw, 2.2rem);
      font-family:'Dancing Script',cursive;
      text-shadow: 1px 1px 0 rgba(0,0,0,.35);
    }
    .card-back{
      background:#fff;
      color:#111;
      transform: rotateY(180deg);
      font-size: clamp(.72rem, 1.6vw, 1.05rem);
      text-align:center;
      word-break: break-word;
      line-height:1.15;
    }
    .card-back.reward{ background: linear-gradient(to bottom, #fff9c4, #fff176); color:#b71c1c; }
    .card-back.punish{ background: linear-gradient(to bottom, #424242, #111); color:#fff; }

    /* --- SIDEBAR --- */
    .sidebar{
      width: 360px;
      max-width: 360px;
      flex: 0 0 auto;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      padding: 14px;
      border-left: 2px solid rgba(255,215,0,.85);
      border-radius: 14px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    h1{
      font-family:'Dancing Script',cursive;
      color:var(--text-gold);
      text-align:center;
      margin:0 0 10px 0;
      text-shadow:2px 2px 4px #000;
      font-size:2.05rem;
      flex-shrink:0;
    }
    .config-btn{
      background:#d32f2f;
      color:#fff;
      border:1px solid rgba(255,215,0,.9);
      padding:10px 12px;
      width:100%;
      font-weight:800;
      cursor:pointer;
      margin-bottom:10px;
      border-radius:10px;
      transition:.2s;
    }
    .config-btn:hover{ filter: brightness(1.05); }

    .stats-container{
      flex:1;
      overflow:auto;
      border-bottom:1px dashed rgba(255,255,255,.25);
      padding-bottom:10px;
      margin-bottom:10px;
      -webkit-overflow-scrolling: touch;
    }
    .stats-table{ width:100%; border-collapse:collapse; font-size:.92rem; }
    .stats-table th, .stats-table td{ text-align:left; padding:6px 6px; border-bottom:1px solid rgba(255,255,255,.10); }
    .stats-table th{ color: var(--gold); position: sticky; top:0; background: rgba(0,0,0,.70); backdrop-filter: blur(8px); }
    .count-badge{
      background: var(--primary-red);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .78rem;
      float:right;
      min-width: 32px;
      text-align:center;
    }

    .control-panel{
      background: rgba(255,255,255,.10);
      padding: 10px;
      border-radius: 12px;
      flex-shrink:0;
    }
    .control-group{ margin-bottom: 10px; }
    label{ display:block; margin-bottom:5px; font-size:.88rem; }
    input[type="range"], input[type="file"]{ width:100%; }
    .btn-reset{
      width:100%;
      padding:10px;
      background:#2f2f2f;
      color:#fff;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
    }

    .btn-secondary{
      width:100%;
      padding:10px;
      background:#0f3d91;
      color:#fff;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      margin-bottom:8px;
    }
    .audio-status{
      font-size:.82rem;
      opacity:.9;
      line-height:1.2;
    }

    /* --- MODAL --- */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.82);
      display:none;
      justify-content:center;
      align-items:center;
      z-index: 1000;
      padding: 16px;
    }
    .modal-content{
      background:#fff;
      padding: 26px 22px;
      border-radius: 18px;
      text-align:center;
      width:min(520px, 92vw);
      border: 3px solid rgba(255,215,0,.95);
      color:#222;
      animation: popIn .22s ease-out;
      position: relative;
      overflow:hidden;
    }
    @keyframes popIn{ from{ transform: scale(.92); opacity:0 } to{ transform: scale(1); opacity:1 } }

    .config-modal{ width:min(920px, 96vw); text-align:left; }
    .config-area{ display:flex; gap:14px; margin-bottom: 14px; }
    .config-col{ flex:1; min-width:0; }
    textarea{
      width:100%;
      height: 280px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      border:1px solid #ccc;
      border-radius: 10px;
      resize: vertical;
    }

    .modal-title{
      font-size: 2rem;
      margin: 0 0 6px 0;
      font-family:'Dancing Script',cursive;
      color: #b71c1c;
    }
    .modal-desc{
      font-size: 1.35rem;
      margin: 0 0 16px 0;
      font-weight: 900;
    }
    .modal-icon{ font-size: 4.4rem; display:block; margin-bottom: 8px; }
    .btn-action{
      padding: 11px 18px;
      border:none;
      border-radius: 12px;
      font-size: 1rem;
      cursor:pointer;
      font-weight: 900;
      margin: 6px 6px 0 0;
    }
    .btn-primary{ background: var(--primary-red); color:#fff; }
    .btn-secondary{ background:#757575; color:#fff; }

    /* Reward/Punish suspense reveal */
    .reveal-wrap{
      display:inline-block;
      filter: blur(10px);
      opacity: .1;
      transform: translateY(10px);
      transition: filter .8s ease, opacity .8s ease, transform .8s ease;
    }
    .modal-content.revealed .reveal-wrap{
      filter: blur(0);
      opacity: 1;
      transform: translateY(0);
    }
    .modal-content.type-reward{
      background: linear-gradient(180deg, #fffde7, #fff8e1);
      border-color: rgba(255,215,0,.95);
    }
    .modal-content.type-punish{
      background: linear-gradient(180deg, #1b1b1b, #0b0b0b);
      color:#fff;
      border-color: rgba(255,255,255,.18);
    }
    .modal-content.type-punish .modal-title{ color:#fff; }
    .modal-content.type-punish .btn-primary{ background:#ff5252; }
    .modal-glow{
      position:absolute; inset:-80px;
      background: radial-gradient(circle, rgba(255,215,0,.35), transparent 60%);
      opacity:0;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .modal-content.type-reward .modal-glow{ opacity:1; }


    @keyframes punishShake{
      0%{ transform: translateX(0) }
      15%{ transform: translateX(-6px) }
      30%{ transform: translateX(6px) }
      45%{ transform: translateX(-4px) }
      60%{ transform: translateX(4px) }
      75%{ transform: translateX(-2px) }
      100%{ transform: translateX(0) }
    }
    .modal-content.type-punish.revealed{
      animation: popIn .22s ease-out, punishShake .45s ease-out;
    }

    /* Confetti canvas */
    #fxCanvas{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 1500;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 980px){
      .sidebar{ width: 330px; max-width: 330px; }
      .grid-container{ width:min(100%, 760px); height:min(calc(100dvh - 16px - var(--safe-top) - var(--safe-bottom)), 760px); }
    }

    /* iPad/iPhone portrait: stack */
    @media (max-width: 820px){
      body{
        flex-direction: column;
        gap:10px;
      }
      .sidebar{
        width: 100%;
        max-width: none;
        border-left: none;
        border-top: 2px solid rgba(255,215,0,.85);
      }
      .game-area{ order: 1; }
      .sidebar{ order: 2; }
      .grid-container{
        width: min(100%, 980px);
        height: auto;
        aspect-ratio: 1/1;
      }
      .config-area{ flex-direction: column; }
      textarea{ height: 220px; }
    }

    /* iPhone landscape: keep sidebar but smaller */
    @media (max-height: 430px) and (orientation: landscape){
      body{ gap:8px; }
      h1{ font-size: 1.55rem; margin-bottom: 6px; }
      .config-btn{ padding:8px 10px; margin-bottom: 8px; }
      .sidebar{ width: 300px; max-width: 300px; padding: 10px; }
      .stats-table{ font-size: .86rem; }
      .control-panel{ padding: 8px; }
      .grid-container{
        height: min(calc(100dvh - 16px - var(--safe-top) - var(--safe-bottom)), 640px);
      }
    }
  </style>
</head>
<body>
  <canvas id="fxCanvas"></canvas>

  <audio id="unlockSound" preload="auto" playsinline src="data:audio/wav;base64,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"></audio>

  <div class="game-area">
    <div class="grid-container" id="grid"></div>
  </div>

  <div class="sidebar">
    <h1>H·∫£i S·∫£n K·ª≥ H√†</h1>
    <button class="config-btn" onclick="openConfigModal()">‚öôÔ∏è C·∫•u H√¨nh Th∆∞·ªüng / Ph·∫°t</button>

    <div class="stats-container">
      <table class="stats-table" id="statsTable"></table>
    </div>

    <div class="control-panel">
      <div class="control-group">
        <label>üéµ Nh·∫°c n·ªÅn (Ch·ªçn file MP3):</label>
        <input type="file" id="bgmInput" accept="audio/*">
      </div>
      <div class="control-group">
        <label>üîä √Çm l∆∞·ª£ng:</label>
        <input type="range" id="volControl" min="0" max="1" step="0.05" value="0.5">
      </div>
      <div class="control-group">
        <label><input type="checkbox" id="sfxToggle" checked> B·∫≠t ti·∫øng hi·ªáu ·ª©ng</label>
      </div>

      <div class="control-group audio-test">
        <button type="button" id="testSfxBtn" class="btn-secondary">üîä Test √¢m thanh</button>
        <div id="audioStatus" class="audio-status">√Çm thanh: ch∆∞a k√≠ch ho·∫°t (ch·∫°m ƒë·ªÉ b·∫≠t)</div>
      </div>
      <button class="btn-reset" onclick="resetGame()">üîÑ L√†m m·ªõi tr√≤ ch∆°i</button>
    </div>
  </div>

  <!-- Result modal -->
  <div class="modal-overlay" id="resultModal" aria-hidden="true">
    <div class="modal-content" id="resultContent" role="dialog" aria-modal="true">
      <div class="modal-glow"></div>
      <span class="modal-icon" id="resIcon"></span>
      <div class="modal-title" id="resTitle">TITLE</div>
      <div class="modal-desc"><span class="reveal-wrap" id="resDesc">Content</span></div>
      <button class="btn-action btn-primary" onclick="closeResultModal()">Ti·∫øp t·ª•c ch∆°i</button>
    </div>
  </div>

  <!-- Config modal -->
  <div class="modal-overlay" id="configModal" aria-hidden="true">
    <div class="modal-content config-modal">
      <h2 style="margin-top:0; color:#b71c1c;">C·∫•u H√¨nh N·ªôi Dung</h2>
      <p style="font-size:0.9rem; color:#666; margin-top:6px;">
        Nh·∫≠p theo c√∫ ph√°p: <strong>T√™n ph·∫ßn th∆∞·ªüng : S·ªë l∆∞·ª£ng</strong> (M·ªói lo·∫°i 1 d√≤ng)
      </p>

      <div class="config-area">
        <div class="config-col">
          <label style="font-weight:900; color:#d50000">DANH S√ÅCH TH∆Ø·ªûNG</label>
          <textarea id="inputRewards"></textarea>
        </div>
        <div class="config-col">
          <label style="font-weight:900; color:#424242">DANH S√ÅCH PH·∫†T</label>
          <textarea id="inputPunishments"></textarea>
        </div>
      </div>

      <div style="text-align:right;">
        <button class="btn-action btn-secondary" onclick="closeConfigModal()">H·ªßy</button>
        <button class="btn-action btn-primary" onclick="saveConfig()">L∆∞u & L√†m M·ªõi Game</button>
      </div>
    </div>
  </div>

  <!-- Keep old audio tags for compatibility (fallback / optional) -->
  <audio id="bgm-player" loop></audio>

  <script>
    // =========================
    //  SETTINGS
    // =========================
    const TOTAL_TILES = 100; // gi·ªØ ƒë√∫ng "100 √¥"
    let gridCols = 10; // s·∫Ω t·ª± t√≠nh theo TOTAL_TILES

    // --- D·ªÆ LI·ªÜU M·∫∂C ƒê·ªäNH (theo y√™u c·∫ßu m·ªõi) ---
    // L∆∞u √Ω: t·ªïng c√°c s·ªë b·∫°n ƒë∆∞a ra l√† 105. ƒê·ªÉ v·∫´n gi·ªØ 100 √¥, game s·∫Ω "quy ƒë·ªïi theo t·ªâ l·ªá" ƒë·ªÉ kh·ªõp TOTAL_TILES,
    // sau ƒë√≥ t·ª± fill ph·∫ßn c√≤n thi·∫øu b·∫±ng "Ch√∫c may m·∫Øn l·∫ßn sau".
    const defaultRewardsRaw = [
      { name: "1 Tri·ªáu ti·ªÅn m·∫∑t", count: 1 },
      { name: "500K ti·ªÅn m·∫∑t", count: 3 },
      { name: "200K ti·ªÅn m·∫∑t", count: 10 },
      { name: "100K ti·ªÅn m·∫∑t", count: 10 },
      { name: "50K ti·ªÅn m·∫∑t", count: 26 },
      { name: "Tr√†ng ph√°o tay", count: 5 }
    ];

    const defaultPunishmentsRaw = [
      { name: "U·ªëng 100%", count: 5 },
      { name: "U·ªëng 50%", count: 20 },
      { name: "L√¨ x√¨ s·∫øp 50K", count: 5 },
      { name: "L√¨ x√¨ ng∆∞·ªùi b√™n tr√°i 50K", count: 5 },
      { name: "L√¨ x√¨ ng∆∞·ªùi b√™n ph·∫£i 50K", count: 5 },
      { name: "H√°t 1 B√†i nh·∫°c Xu√¢n", count: 5 },
      { name: "U·ªëng c√πng 1 ng∆∞·ªùi b·∫•t k·ª≥ 50%", count: 5 }
    ];

    // =========================
    //  STATE
    // =========================
    let currentGameData = [];
    let currentRewards = [];
    let currentPunishments = [];

    // =========================
    //  AUDIO (WebAudio - iOS/iPad safe unlock)
    // =========================
    let audioCtx = null;
    let masterGain = null;
    let audioUnlocked = false;
    let pendingResume = null;

    function getSfxEnabled(){
      const el = document.getElementById('sfxToggle');
      return !!(el && el.checked);
    }

    function syncVolume(){
      if (!masterGain) return;
      const volEl = document.getElementById('volControl');
      const vol = parseFloat((volEl && volEl.value) || "0.5");
      masterGain.gain.value = Math.max(0, Math.min(1, vol));
    }

    function ensureAudioContext(){
      if (!getSfxEnabled()) return false;

      if (!audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        audioCtx = new Ctx();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.6;
        masterGain.connect(audioCtx.destination);
      }
      syncVolume();

      // iOS/Safari: resume must be triggered by a user gesture. We keep the promise so play calls can wait.
      if (audioCtx.state !== 'running') {
        if (!pendingResume) {
          pendingResume = audioCtx.resume().catch(()=>{}).finally(()=>{ pendingResume = null; });
        }
      }
      return true;
    }

    function unlockAudioGesture(){
      if (!getSfxEnabled()) { updateAudioStatus(); return; }

      // Create AudioContext ONLY inside a user gesture for iOS
      if (!audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        try {
          audioCtx = new Ctx();
          masterGain = audioCtx.createGain();
          masterGain.gain.value = 0.6;
          masterGain.connect(audioCtx.destination);
        } catch(e) {
          updateAudioStatus();
          return;
        }
      }
      syncVolume();

      // Always attempt to resume inside the same gesture
      let resumeP = Promise.resolve();
      if (audioCtx.state !== 'running') {
        try { resumeP = audioCtx.resume(); } catch(e) { resumeP = Promise.resolve(); }
      }

      // HTMLAudio unlock (audible enough to confirm on iPad)
      const unlockEl = document.getElementById('unlockSound');
      if (unlockEl) {
        try {
          unlockEl.volume = 0.08;
          unlockEl.currentTime = 0;
          const p = unlockEl.play();
          if (p && p.then) {
            p.then(()=>{ try{ unlockEl.pause(); unlockEl.currentTime = 0; }catch(e){} }).catch(()=>{});
          }
        } catch(e) {}
      }

      // Mark unlocked once resume completes (best-effort)
      Promise.resolve(resumeP).then(()=>{
        try { audioUnlocked = (audioCtx && audioCtx.state === 'running'); } catch(e) { audioUnlocked = true; }
        updateAudioStatus();
      }).catch(()=>{
        audioUnlocked = true;
        updateAudioStatus();
      });
    }

    // Attach unlock on the earliest possible gestures (covers iPad/iPhone Safari)
 on the earliest possible gestures (covers iPad/iPhone Safari)
    window.addEventListener('pointerdown', unlockAudioGesture, {passive:true});
    window.addEventListener('touchstart', unlockAudioGesture, {passive:true});
    window.addEventListener('mousedown', unlockAudioGesture, {passive:true});


    function updateAudioStatus(){
      const el = document.getElementById('audioStatus');
      if (!el) return;
      const sfxOn = getSfxEnabled();
      const state = audioCtx ? audioCtx.state : 'no-context';
      if (!sfxOn) {
        el.textContent = '√Çm thanh: ƒëang t·∫Øt (b·∫≠t ‚ÄúB·∫≠t ti·∫øng hi·ªáu ·ª©ng‚Äù)';
        return;
      }
      if (!audioCtx) {
        el.textContent = '√Çm thanh: ch∆∞a kh·ªüi t·∫°o (ch·∫°m ƒë·ªÉ b·∫≠t)';
        return;
      }
      if (state !== 'running') {
        el.textContent = '√Çm thanh: ƒëang b·ªã kh√≥a (ch·∫°m ho·∫∑c b·∫•m ‚ÄúTest √¢m thanh‚Äù)';
        return;
      }
      el.textContent = '√Çm thanh: s·∫µn s√†ng ‚úÖ';
    }

    const __testBtn = document.getElementById('testSfxBtn');
    if (__testBtn) {
      // Use pointerdown so it's guaranteed to be considered a user gesture on iOS
      __testBtn.addEventListener('pointerdown', (ev)=>{
        try { ev.preventDefault(); } catch(e) {}
        unlockAudioGesture();

        // 1) Try a real HTMLAudio play (often more reliable on some iPads)
        const unlockEl = document.getElementById('unlockSound');
        if (unlockEl) {
          try {
            unlockEl.volume = Math.max(0.05, Math.min(1, parseFloat((document.getElementById('volControl')?.value)||'0.5')));
            unlockEl.currentTime = 0;
            const p = unlockEl.play();
            if (p && p.catch) {
              p.catch(()=>{ /* ignore */ });
            }
          } catch(e) {}
        }

        // 2) Try WebAudio test tone too
        playTone({freq: 880, dur: 0.14, type:'sine', gain:0.24, slideTo: 660});
        updateAudioStatus();
      }, {passive:false});
    }
    // keep status updated
    setInterval(updateAudioStatus, 800);

    function playToneInternal({freq=440, dur=0.06, type='sine', gain=0.18, slideTo=null} = {}) {
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t0);
      if (slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, t0 + dur);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      osc.connect(g);
      g.connect(masterGain);
      osc.start(t0);
      osc.stop(t0 + dur + 0.02);
    }

    function playTone(opts) {
      if (!ensureAudioContext()) return;

      // If we're still suspended, wait for resume before playing (fix iPad/iPhone silent SFX)
      if (audioCtx.state !== 'running') {
        const resumeNow = pendingResume || audioCtx.resume().catch(()=>{});
        Promise.resolve(resumeNow).then(()=>{
          try { playToneInternal(opts); } catch(e) {}
        });
        return;
      }
      try { playToneInternal(opts); } catch(e) {}
    }

    // Detect iOS/iPadOS (iPadOS 13+ can report as Mac)
    const __UA = navigator.userAgent || '';
    const __isIOS = /iPad|iPhone|iPod/i.test(__UA) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // HTMLAudio click pool (most compatible on iPad/iPhone, even when WebAudio is flaky)
    let __tapPool = null;
    let __tapIdx = 0;
    function ensureTapPool(){
      if (__tapPool) return;
      const src = document.getElementById('unlockSound')?.getAttribute('src');
      if (!src) return;
      __tapPool = Array.from({length: 10}, ()=>{
        const a = new Audio(src);
        a.preload = 'auto';
        a.playsInline = true;
        return a;
      });
    }
    function playHtmlClick(vol=0.25){
      if (!getSfxEnabled()) return;
      ensureTapPool();
      if (!__tapPool || __tapPool.length === 0) return;
      const a = __tapPool[(__tapIdx++) % __tapPool.length];
      try {
        a.pause();
        a.currentTime = 0;
      } catch(e) {}
      a.volume = Math.max(0, Math.min(1, vol));
      const p = a.play();
      if (p && p.catch) p.catch(()=>{});
    }

    function sfxTap(){
      const vol = parseFloat((document.getElementById('volControl')?.value) || "0.5");
      // On iOS: prefer HTMLAudio click (more likely to produce sound)
      if (__isIOS) {
        playHtmlClick(Math.min(1, vol * 0.35));
      } else {
        playTone({freq: 520, dur: 0.05, type:'triangle', gain: Math.min(0.22, vol*0.22), slideTo: 420});
      }
    }
    function sfxReward(){
      const vol = parseFloat((document.getElementById('volControl')?.value) || "0.5");
      if (__isIOS) playHtmlClick(Math.min(1, vol * 0.45));
      playTone({freq: 660, dur: 0.10, type:'sine', gain: Math.min(0.28, vol*0.28), slideTo: 990});
    }
    function sfxPunish(){
      const vol = parseFloat((document.getElementById('volControl')?.value) || "0.5");
      if (__isIOS) playHtmlClick(Math.min(1, vol * 0.45));
      playTone({freq: 220, dur: 0.12, type:'sawtooth', gain: Math.min(0.22, vol*0.22), slideTo: 140});
    }

    // Keep volume in sync while user drags slider
    const __volEl = document.getElementById('volControl');
    if (__volEl) __volEl.addEventListener('input', ()=>{ ensureAudioContext(); syncVolume(); }, {passive:true});
    const __sfxEl = document.getElementById('sfxToggle');
    if (__sfxEl) __sfxEl.addEventListener('change', ()=>{ if (__sfxEl.checked) unlockAudioGesture(); updateAudioStatus(); }, {passive:true});

    // =========================
    //  HELPERS

    // =========================
    function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }

    function largestRemainderScale(items, targetTotal) {
      const total = items.reduce((s,i)=>s + (parseInt(i.count)||0), 0);
      if (total <= 0) return items.map(i => ({...i, count:0}));
      if (total === targetTotal) return items.map(i => ({...i, count: parseInt(i.count)||0}));

      const scaled = items.map(i => {
        const raw = (parseInt(i.count)||0) * targetTotal / total;
        const base = Math.floor(raw);
        return { ...i, _raw: raw, _base: base, _rem: raw - base, count: base };
      });

      // ensure any item with original count>0 keeps at least 1 if possible
      // (∆∞u ti√™n c√°c lo·∫°i hi·∫øm nh∆∞ 1 Tri·ªáu)
      const rarePriority = (name) => {
        if (/1\s*Tri·ªáu/i.test(name)) return 100;
        if (/500\s*K/i.test(name)) return 50;
        return 0;
      };

      let current = scaled.reduce((s,i)=>s+i.count,0);
      // First: bump zeros with high priority
      const zeros = scaled
        .filter(i => (parseInt(i.count)||0) > 0 && i.count === 0)
        .sort((a,b)=>rarePriority(b.name)-rarePriority(a.name));

      for (const z of zeros) {
        if (current >= targetTotal) break;
        z.count = 1;
        current += 1;
      }

      // Distribute remaining by remainder, then by priority
      if (current < targetTotal) {
        scaled.sort((a,b)=> (b._rem - a._rem) || (rarePriority(b.name)-rarePriority(a.name)));
        let idx = 0;
        while (current < targetTotal) {
          scaled[idx % scaled.length].count += 1;
          current += 1;
          idx += 1;
        }
      } else if (current > targetTotal) {
        // remove extras from lowest remainder / priority
        scaled.sort((a,b)=> (a._rem - b._rem) || (rarePriority(a.name)-rarePriority(b.name)));
        let idx = 0;
        while (current > targetTotal) {
          const it = scaled[idx % scaled.length];
          if (it.count > 0 && !/1\s*Tri·ªáu/i.test(it.name)) { // gi·ªØ 1 Tri·ªáu c√†ng ch·∫Øc c√†ng t·ªët
            it.count -= 1;
            current -= 1;
          }
          idx += 1;
        }
      }

      // cleanup
      return scaled.map(({_raw,_base,_rem, ...rest}) => ({...rest, count: rest.count}));
    }

    function pickIcon(item){
      if (item.type === 'reward') {
        if (/Tri·ªáu|K\s*ti·ªÅn|ti·ªÅn m·∫∑t|50K|100K|200K|500K/i.test(item.name)) return "üí∞";
        if (/ph√°o\s*tay|tr√†ng/i.test(item.name)) return "üëè";
        return "üéÅ";
      }
      // punish
      if (/u·ªëng/i.test(item.name)) return "üç∫";
      if (/l√¨\s*x√¨|lixi|l√¨\s*xi/i.test(item.name)) return "üßß";
      if (/h√°t|b√†i\s*nh·∫°c/i.test(item.name)) return "üé§";
      return "üòà";
    }

    function calcGridDims(n){
      // c·ªë g·∫Øng g·∫ßn vu√¥ng
      const root = Math.sqrt(n);
      let cols = Math.ceil(root);
      while (cols > 1 && n % cols !== 0) cols++;
      // n·∫øu kh√¥ng chia h·∫øt, v·∫´n d√πng ceil v√† ƒë·ªÉ grid t·ª± wrap
      return Math.ceil(root);
    }

    function setGridColumnsFor(n){
      gridCols = calcGridDims(n);
      const grid = document.getElementById('grid');
      grid.style.gridTemplateColumns = `repeat(${gridCols}, 1fr)`;
      grid.style.gridTemplateRows = `repeat(${Math.ceil(n / gridCols)}, 1fr)`;
    }

    // Late-game bias placement
    function applyLateBias(items){
      // 1 Tri·ªáu: ƒë·∫©y v·ªÅ cu·ªëi game (80% -> 100%)
      const idxs1m = [];
      for (let i=0;i<items.length;i++){
        if (/1\s*Tri·ªáu/i.test(items[i].name) && items[i].type==='reward') idxs1m.push(i);
      }
      if (idxs1m.length > 0){
        // take first occurrence (should be 1)
        const from = idxs1m[0];
        const [one] = items.splice(from,1);
        const min = Math.floor(items.length * 0.80);
        const to = min + Math.floor(Math.random() * Math.max(1, items.length - min));
        items.splice(to,0,one);
      }

      // 500K: ƒë·∫©y h∆°i v·ªÅ cu·ªëi (60% -> 100%), n·∫øu c√≥
      const idxs500 = [];
      for (let i=0;i<items.length;i++){
        if (/500\s*K/i.test(items[i].name) && items[i].type==='reward') idxs500.push(i);
      }
      // move each one (stable-ish)
      for (let k=0;k<idxs500.length;k++){
        const pos = items.findIndex(x => x.type==='reward' && /500\s*K/i.test(x.name));
        if (pos === -1) break;
        const [it] = items.splice(pos,1);
        const min = Math.floor(items.length * 0.60);
        const to = min + Math.floor(Math.random() * Math.max(1, items.length - min));
        items.splice(to,0,it);
      }
      return items;
    }

    // =========================
    //  GAME INIT
    // =========================
    function initGame(rewardsInput, punishmentsInput){
      // Deep copy
      currentRewards = deepCopy(rewardsInput);
      currentPunishments = deepCopy(punishmentsInput);

      // Scale to TOTAL_TILES if needed
      const combined = [...currentRewards.map(x=>({...x, type:'reward'})), ...currentPunishments.map(x=>({...x, type:'punish'}))];
      const scaled = largestRemainderScale(combined, TOTAL_TILES);

      currentRewards = scaled.filter(x=>x.type==='reward').map(({type, ...r})=>r);
      currentPunishments = scaled.filter(x=>x.type==='punish').map(({type, ...p})=>p);

      let items = [];
      currentRewards.forEach(item=>{
        for(let i=0;i<item.count;i++) items.push({ name:item.name, type:'reward', icon: pickIcon({name:item.name,type:'reward'}) });
      });
      currentPunishments.forEach(item=>{
        for(let i=0;i<item.count;i++) items.push({ name:item.name, type:'punish', icon: pickIcon({name:item.name,type:'punish'}) });
      });

      // Fill n·∫øu thi·∫øu
      while(items.length < TOTAL_TILES){
        items.push({ name:"Ch√∫c may m·∫Øn l·∫ßn sau", type:"reward", icon:"üçÄ" });
      }
      if(items.length > TOTAL_TILES) items = items.slice(0, TOTAL_TILES);

      // Shuffle
      for(let i=items.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [items[i], items[j]] = [items[j], items[i]];
      }

      // Bias rare prizes
      items = applyLateBias(items);

      currentGameData = items;
      setGridColumnsFor(TOTAL_TILES);
      renderGrid();
      renderStats();
    }

    function renderGrid(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      const frag = document.createDocumentFragment();

      currentGameData.forEach((item, index)=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('role','button');
        card.setAttribute('aria-label', `√î s·ªë ${index+1}`);

        // Use pointerup for better mobile responsiveness
        card.addEventListener('pointerup', (e)=>{
          e.preventDefault();
          flipCard(card, index);
        }, {passive:false});

        const front = document.createElement('div');
        front.className = 'card-face card-front';
        front.textContent = index + 1;

        const back = document.createElement('div');
        back.className = 'card-face card-back';

        card.appendChild(front);
        card.appendChild(back);
        frag.appendChild(card);
      });

      grid.appendChild(frag);
    }

    // =========================
    //  FLIP + RESULT
    // =========================
    let lastTapFrame = -1;
    function flipCard(card, index){
      if (card.classList.contains('flipped')) return;

      // tap SFX: gi·ªõi h·∫°n 1 l·∫ßn/animation frame ƒë·ªÉ kh√¥ng "r√®" khi spam
      const f = Math.floor(performance.now()/16);
      if (f !== lastTapFrame) { sfxTap(); lastTapFrame = f; }

      const item = currentGameData[index];
      const backFace = card.querySelector('.card-back');
      backFace.textContent = item.name;
      backFace.classList.add(item.type);

      card.classList.add('flipped');

      // suspense delay
      setTimeout(()=>{
        showResult(item);
        updateStatsCount(item);
        renderStats();
      }, 520);
    }

    function updateStatsCount(item){
      const source = item.type === 'reward' ? currentRewards : currentPunishments;
      const found = source.find(i => i.name === item.name);
      if (found && found.count > 0) found.count--;
    }

    function renderStats(){
      const table = document.getElementById('statsTable');
      let html = `<tr><th colspan="2" style="color:#ffeb3b">üéÅ PH·∫¶N TH∆Ø·ªûNG</th></tr>`;
      currentRewards.forEach(item=>{
        if(item.count > 0){
          html += `<tr><td>${item.name}</td><td><span class="count-badge">${item.count}</span></td></tr>`;
        }
      });

      html += `<tr><th colspan="2" style="color:#bdbdbd; padding-top:10px">üòà H√åNH PH·∫†T</th></tr>`;
      currentPunishments.forEach(item=>{
        if(item.count > 0){
          html += `<tr><td>${item.name}</td><td><span class="count-badge" style="background:#424242">${item.count}</span></td></tr>`;
        }
      });

      table.innerHTML = html;
    }

    // =========================
    //  CONFIG MODAL
    // =========================
    function openConfigModal(){
      const rewardText = currentRewards.map(i => `${i.name} : ${i.count}`).join('\n');
      const punishText = currentPunishments.map(i => `${i.name} : ${i.count}`).join('\n');
      document.getElementById('inputRewards').value = rewardText;
      document.getElementById('inputPunishments').value = punishText;
      document.getElementById('configModal').style.display = 'flex';
      document.getElementById('configModal').setAttribute('aria-hidden','false');
    }
    function closeConfigModal(){
      document.getElementById('configModal').style.display = 'none';
      document.getElementById('configModal').setAttribute('aria-hidden','true');
    }

    function saveConfig(){
      const parseText = (text) => {
        return text.split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(line=>{
            const parts = line.split(':');
            if (parts.length < 2) return null;
            const name = parts[0].trim();
            const count = parseInt(parts.slice(1).join(':').trim(), 10);
            if (!name || Number.isNaN(count)) return null;
            return { name, count: Math.max(0, count) };
          })
          .filter(Boolean);
      };

      const newRewards = parseText(document.getElementById('inputRewards').value);
      const newPunish  = parseText(document.getElementById('inputPunishments').value);

      if (newRewards.length === 0 && newPunish.length === 0){
        alert("Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng: T√™n : S·ªë l∆∞·ª£ng");
        return;
      }
      initGame(newRewards, newPunish);
      closeConfigModal();
      alert("ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh v√† l√†m m·ªõi tr√≤ ch∆°i!");
    }

    // =========================
    //  RESULT MODAL + FX
    // =========================
    function showResult(item){
      const modal = document.getElementById('resultModal');
      const content = document.getElementById('resultContent');
      const icon = document.getElementById('resIcon');

      content.className = 'modal-content';
      content.classList.add(item.type === 'reward' ? 'type-reward' : 'type-punish');
      content.classList.remove('revealed');

      document.getElementById('resTitle').innerText = item.type === 'reward' ? "CH√öC M·ª™NG!" : "H√åNH PH·∫†T";
      document.getElementById('resDesc').innerText = item.name;
      icon.innerText = item.icon;

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');

      // suspense: reveal after a short delay (punish ch·∫≠m h∆°n ƒë·ªÉ h·ªìi h·ªôp)
      const revealDelay = (item.type === 'punish') ? 520 : 220;
      setTimeout(()=> content.classList.add('revealed'), revealDelay);

      // contextual sound + fx
      if (item.type === 'reward') {
        sfxReward();
        burstConfetti();
      } else {
        sfxPunish();
        pulseDark();
      }
    }

    function closeResultModal(){
      const modal = document.getElementById('resultModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    // ESC closes modals
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){
        const res = document.getElementById('resultModal');
        const cfg = document.getElementById('configModal');
        if (res.style.display === 'flex') closeResultModal();
        if (cfg.style.display === 'flex') closeConfigModal();
      }
    });

    // =========================
    //  CONFETTI / FX CANVAS
    // =========================
    const fxCanvas = document.getElementById('fxCanvas');
    const fx = fxCanvas.getContext('2d');
    let particles = [];
    let fxRAF = null;

    function resizeFx(){
      fxCanvas.width = window.innerWidth * devicePixelRatio;
      fxCanvas.height = window.innerHeight * devicePixelRatio;
      fx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', resizeFx);
    resizeFx();

    function burstConfetti(){
      const w = window.innerWidth, h = window.innerHeight;
      const x = w * (0.35 + Math.random()*0.30);
      const y = h * 0.22;

      const n = 160;
      for (let i=0;i<n;i++){
        const ang = (Math.random()*Math.PI*2);
        const spd = 2 + Math.random()*6;
        particles.push({
          x, y,
          vx: Math.cos(ang)*spd,
          vy: Math.sin(ang)*spd - (2 + Math.random()*2),
          g: 0.08 + Math.random()*0.08,
          r: 2 + Math.random()*4,
          rot: Math.random()*Math.PI*2,
          vr: -0.2 + Math.random()*0.4,
          life: 60 + Math.random()*50,
          t: 0,
          color: `hsl(${Math.floor(Math.random()*360)}, 95%, 60%)`
        });
      }
      startFxLoop();
    }

    function pulseDark(){
      const overlay = document.getElementById('resultModal');
      overlay.animate(
        [{background:'rgba(0,0,0,.82)'},{background:'rgba(0,0,0,.92)'},{background:'rgba(0,0,0,.82)'}],
        {duration: 520, easing:'ease-out'}
      );
    }

    function startFxLoop(){
      if (fxRAF) return;
      fxRAF = requestAnimationFrame(tickFx);
    }

    function tickFx(){
      fx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
      particles = particles.filter(p => p.t < p.life);

      for (const p of particles){
        p.t += 1;
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;

        const alpha = Math.max(0, Math.min(1, 1 - p.t/p.life));
        fx.save();
        fx.globalAlpha = alpha;
        fx.fillStyle = p.color || '#fff';
        fx.translate(p.x, p.y);
        fx.rotate(p.rot);
        fx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        fx.restore();
      }

      if (particles.length > 0){
        fxRAF = requestAnimationFrame(tickFx);
      } else {
        fxRAF = null;
        fx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
      }
    }

    // =========================
    //  BGM + VOLUME
    // =========================
    document.getElementById('bgmInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const player = document.getElementById('bgm-player');
      player.src = url;
      player.volume = parseFloat(document.getElementById('volControl').value || "0.5");
      // iOS: must be triggered by user gesture -> this event is ok
      player.play().catch(()=>{});
    });

    document.getElementById('volControl').addEventListener('input', function(e){
      const v = parseFloat(e.target.value || "0.5");
      document.getElementById('bgm-player').volume = v;
      if (masterGain) masterGain.gain.value = Math.max(0, Math.min(1, v));
    });

    // Unlock audio on first interaction (iOS)
    window.addEventListener('pointerdown', ()=>{ ensureAudio(); }, {once:true, passive:true});

    function resetGame(){
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô √¥ ƒë√£ m·ªü kh√¥ng?")){
        initGame(currentRewards, currentPunishments);
      }
    }

    // =========================
    //  START
    // =========================
    initGame(defaultRewardsRaw, defaultPunishmentsRaw);
  </script>
</body>
</html>
